<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Salman Naqvi">
<meta name="description" content="First I implement from scratch. Then I progressively reimplement with PyTorch. It is simpler than you think.">

<title>Implementing a Neural Network from Scratch – ForBo7 // Salman Naqvi</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-de070a7b0ab54f8780927367ac907214.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-9d328625eae6b2c2b67d09ca63512aee.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<meta name="mermaid-theme" content="neutral">
<script src="../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Implementing a Neural Network from Scratch – ForBo7 // Salman Naqvi">
<meta property="og:description" content="First I implement from scratch. Then I progressively reimplement with PyTorch. It is simpler than you think.">
<meta property="og:image" content="https://forbo7.github.io/forblog/images/20_model_from_scratch/thumbnail.jpeg">
<meta property="og:site_name" content="ForBo7 // Salman Naqvi">
<meta name="twitter:title" content="ForBo7 // Salman Naqvi">
<meta name="twitter:description" content="First I implement from scratch. Then I progressively reimplement with PyTorch. It is simpler than you think.">
<meta name="twitter:image" content="https://forbo7.github.io/forblog/images/20_model_from_scratch/thumbnail.jpeg">
<meta name="twitter:creator" content="@ForBo7">
<meta name="twitter:site" content="@ForBo7">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ForBo7 // Salman Naqvi</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> <i class="bi bi-house-door" role="img">
</i> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../forblog/index.html"> <i class="bi bi-newspaper" role="img">
</i> 
<span class="menu-text">ForBlog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../bitsandbobs/index.html"> <i class="bi bi-puzzle" role="img">
</i> 
<span class="menu-text">Bits and Bobs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../dictionary/index.html"> <i class="bi bi-book" role="img">
</i> 
<span class="menu-text">Dictionary</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> <i class="bi bi-file-person" role="img">
</i> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/ForBo7/forbo7.github.io" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-code-slash"></i></a>
    <a href="../../forblog/index.xml" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-rss"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#download-data" id="toc-download-data" class="nav-link active" data-scroll-target="#download-data">Download Data</a></li>
  <li><a href="#a-single-neuron" id="toc-a-single-neuron" class="nav-link" data-scroll-target="#a-single-neuron">A Single Neuron</a></li>
  <li><a href="#loss-function" id="toc-loss-function" class="nav-link" data-scroll-target="#loss-function">Loss Function</a></li>
  <li><a href="#backward-pass" id="toc-backward-pass" class="nav-link" data-scroll-target="#backward-pass">Backward Pass</a>
  <ul>
  <li><a href="#w1-gradients" id="toc-w1-gradients" class="nav-link" data-scroll-target="#w1-gradients"><code>w1</code> Gradients</a></li>
  <li><a href="#b1-gradients" id="toc-b1-gradients" class="nav-link" data-scroll-target="#b1-gradients"><code>b1</code> Gradients</a></li>
  <li><a href="#trn_x-gradients" id="toc-trn_x-gradients" class="nav-link" data-scroll-target="#trn_x-gradients"><code>trn_x</code> Gradients</a></li>
  <li><a href="#w1-gradients-1" id="toc-w1-gradients-1" class="nav-link" data-scroll-target="#w1-gradients-1"><code>w1</code> Gradients</a></li>
  <li><a href="#b2-gradients" id="toc-b2-gradients" class="nav-link" data-scroll-target="#b2-gradients"><code>b2</code> Gradients</a></li>
  <li><a href="#verify" id="toc-verify" class="nav-link" data-scroll-target="#verify">Verify</a></li>
  </ul></li>
  <li><a href="#encapsulate" id="toc-encapsulate" class="nav-link" data-scroll-target="#encapsulate">Encapsulate</a>
  <ul>
  <li><a href="#class" id="toc-class" class="nav-link" data-scroll-target="#class">Class</a></li>
  <li><a href="#super-class" id="toc-super-class" class="nav-link" data-scroll-target="#super-class">Super Class</a></li>
  <li><a href="#pytorchs-nn.module" id="toc-pytorchs-nn.module" class="nav-link" data-scroll-target="#pytorchs-nn.module">PyTorch’s <code>nn.Module</code></a></li>
  </ul></li>
  <li><a href="#cross-entropy-loss" id="toc-cross-entropy-loss" class="nav-link" data-scroll-target="#cross-entropy-loss">Cross Entropy Loss</a>
  <ul>
  <li><a href="#integer-array-indexing" id="toc-integer-array-indexing" class="nav-link" data-scroll-target="#integer-array-indexing">Integer Array Indexing</a></li>
  </ul></li>
  <li><a href="#basic-training-loop" id="toc-basic-training-loop" class="nav-link" data-scroll-target="#basic-training-loop">Basic Training Loop</a></li>
  <li><a href="#parameters-optimizers" id="toc-parameters-optimizers" class="nav-link" data-scroll-target="#parameters-optimizers">Parameters &amp; Optimizers</a>
  <ul>
  <li><a href="#registering-modules" id="toc-registering-modules" class="nav-link" data-scroll-target="#registering-modules">Registering Modules</a></li>
  <li><a href="#optimizer" id="toc-optimizer" class="nav-link" data-scroll-target="#optimizer">Optimizer</a></li>
  </ul></li>
  <li><a href="#dataset-and-dataloader" id="toc-dataset-and-dataloader" class="nav-link" data-scroll-target="#dataset-and-dataloader">Dataset and Dataloader</a>
  <ul>
  <li><a href="#dataset" id="toc-dataset" class="nav-link" data-scroll-target="#dataset">Dataset</a></li>
  <li><a href="#dataloader" id="toc-dataloader" class="nav-link" data-scroll-target="#dataloader">DataLoader</a></li>
  <li><a href="#random-sampling" id="toc-random-sampling" class="nav-link" data-scroll-target="#random-sampling">Random Sampling</a></li>
  <li><a href="#collation" id="toc-collation" class="nav-link" data-scroll-target="#collation">Collation</a></li>
  <li><a href="#multiprocessing-dataloader" id="toc-multiprocessing-dataloader" class="nav-link" data-scroll-target="#multiprocessing-dataloader">Multiprocessing DataLoader</a></li>
  <li><a href="#sampling-in-pytorch" id="toc-sampling-in-pytorch" class="nav-link" data-scroll-target="#sampling-in-pytorch">Sampling in PyTorch</a></li>
  </ul></li>
  <li><a href="#validation" id="toc-validation" class="nav-link" data-scroll-target="#validation">Validation</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Implementing a Neural Network from Scratch</h1>
<p class="subtitle lead">The DIY Guide to Digital Brain Building</p>
  <div class="quarto-categories">
    <div class="quarto-category">Creating Models</div>
    <div class="quarto-category">Programming</div>
    <div class="quarto-category">Python</div>
    <div class="quarto-category">PyTorch</div>
  </div>
  </div>

<div>
  <div class="description">
    First I implement from scratch. Then I progressively reimplement with PyTorch. It is simpler than you think.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Salman Naqvi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">Sunday, 26 May 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<blockquote class="blockquote">
<p>This notebook follows the <a href="https://docs.fast.ai/dev/style.html">fastai style guide</a>.</p>
</blockquote>
<p><img src="../images/20_model_from_scratch/thumbnail.jpeg" class="img-fluid" alt="The image features a person engaged in wood carving, with their face hidden by a color block. They are wearing an orange robe and using a chisel to create intricate designs on wood. The setting blends elements of a forest and architectural columns, with dramatic lighting that accentuates the carver and their craft. The scene evokes a sense of both indoor and outdoor space, with a focus on the artistry of wood carving."></p>
<p>In this notebook, I will implement a neural network from scratch, and iteratively reimplement with PyTorch. That is, I will implement each element of the training and inference process from scratch, before then using the corresponding element in PyTorch. This notebook assumes a prior understanding of the flow and pieces of a neural network.</p>
<p>To recap, the complete training loop of a neural network looks like this.</p>
<div class="grid">
<div class="g-col-4">

</div>
<div class="g-col-4">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TB
  A[Load Data] --&gt; B[Make Predictions] --&gt; C[Compute Loss] --&gt; D[Compute Gradients] --&gt; E[Update Weights] --&gt; F[Compute Metric] --&gt; A
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
<div class="g-col-4">

</div>
</div>
<p>This notebook also serves to show the modular nature of PyTorch.</p>
<p>Let’s get started with some data.</p>
<section id="download-data" class="level2">
<h2 class="anchored" data-anchor-id="download-data">Download Data</h2>
<p>The goal of our model will be to classify digits from the MNIST dataset.</p>
<div id="cell-8" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>MNIST_URL <span class="op">=</span> <span class="st">'https://github.com/mnielsen/neural-networks-and-deep-learning/blob/master/data/mnist.pkl.gz?raw=true'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>d_path <span class="op">=</span> Path(<span class="st">'data'</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>d_path.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>d_path <span class="op">=</span> d_path<span class="op">/</span><span class="st">'mnist.pkl.gz'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> d_path.exists(): urlretrieve(MNIST_URL, d_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-10" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span> ls <span class="op">-</span>l data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>total 33312
-rw-r--r--  1 salmannaqvi  staff  17051982 May 12 12:37 mnist.pkl.gz</code></pre>
</div>
</div>
<div id="cell-11" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="annotated-cell-4" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-4-1"><a href="#annotated-cell-4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gzip, pickle</span>
<span id="annotated-cell-4-2"><a href="#annotated-cell-4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> tensor</span>
<span id="annotated-cell-4-3"><a href="#annotated-cell-4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> gzip.<span class="bu">open</span>(d_path, <span class="st">'rb'</span>) <span class="im">as</span> f: ((trn_x, trn_y), (vld_x, vld_y), _) <span class="op">=</span> pickle.load(f, encoding<span class="op">=</span><span class="st">'latin-1'</span>)</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-4" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-4-4" class="code-annotation-target"><a href="#annotated-cell-4-4" aria-hidden="true" tabindex="-1"></a>trn_x, trn_y, vld_x, vld_y <span class="op">=</span> <span class="bu">map</span>(tensor, [trn_x[:<span class="dv">1000</span>], trn_y[:<span class="dv">1000</span>], vld_x[:<span class="dv">1000</span>], vld_y[:<span class="dv">1000</span>]])</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-4" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-4" data-code-lines="4" data-code-annotation="1">Taking 1000 samples each for the sake of speed.</span>
</dd>
</dl>
</div>
</div>
</section>
<section id="a-single-neuron" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="a-single-neuron">A Single Neuron</h2>
<p>A neuron comprises of a set of weights, the linear function, and the activation function.</p>
<div class="grid">
<div class="g-col-4">

</div>
<div class="g-col-4">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR
  A1[Weights]
  A2[Inputs]
  A1 &amp; A2 --&gt; B[Linear Combination] --&gt; C[Activation Function]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
<div class="g-col-4">

</div>
</div>
<p>Our dataset contains one thousand 28x28 pixel samples. Therefore, each sample has 28x28=784 inputs. Since we will be classifying digits, there will be 10 outputs–a probablity for each digit.</p>
<div id="cell-16" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>n, m <span class="op">=</span> trn_x.shape</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>c <span class="op">=</span> trn_y.<span class="bu">max</span>() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>n, m, c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<pre data-code-line-numbers=""><code>(1000, 784, tensor(10))</code></pre>
</div>
</div>
<p>Let’s have 50 neurons comprise the hidden layer.</p>
<div id="cell-18" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>nh <span class="op">=</span> <span class="dv">50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From these dimensions, we can create our appropriate weights…</p>
<div id="cell-20" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch<span class="op">;</span> torch.set_printoptions(precision<span class="op">=</span><span class="dv">2</span>, linewidth<span class="op">=</span><span class="dv">140</span>, sci_mode<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>w1, b1 <span class="op">=</span> torch.randn(m, nh), torch.zeros(nh)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>w2, b2 <span class="op">=</span> torch.randn(nh, <span class="dv">1</span>), torch.zeros(<span class="dv">1</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>w1.shape, b1.shape, w2.shape, b2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre data-code-line-numbers=""><code>(torch.Size([784, 50]), torch.Size([50]), torch.Size([50, 1]), torch.Size([1]))</code></pre>
</div>
</div>
<p>…and create our linear model!</p>
<div id="cell-22" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb10" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lin(x, w, b): <span class="cf">return</span> x <span class="op">@</span> w <span class="op">+</span> b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-23" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb11" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> lin(vld_x, w1, b1)<span class="op">;</span> t.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre data-code-line-numbers=""><code>torch.Size([1000, 50])</code></pre>
</div>
</div>
<div id="cell-24" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb13" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>vld_x.shape, w1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre data-code-line-numbers=""><code>(torch.Size([1000, 784]), torch.Size([784, 50]))</code></pre>
</div>
</div>
<div id="cell-25" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb15" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastcore.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>test_eq(lin(vld_x, w1, b1), F.linear(vld_x, w1.T, b1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our implementation produces the same outputs as PyTorch’s implementation.</p>
<p>We now need to implement the activation function, which will be the ReLU (rectified linear unit). Any value less than 0 gets clipped to 0. There are multiple ways we can approach doing this, such as using <code>torch.max</code>.</p>

<div class="no-row-height column-margin column-container"><div id="cell-27" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb16" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>?torch.<span class="bu">max</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Docstring:</span>

max(input) -&gt; Tensor



Returns the maximum value of all elements in the ``input`` tensor.



.. warning::

    This function produces deterministic (sub)gradients unlike ``max(dim=0)``



Args:

    input (Tensor): the input tensor.



Example::



    &gt;&gt;&gt; a = torch.randn(1, 3)

    &gt;&gt;&gt; a

    tensor([[ 0.6763,  0.7445, -2.2369]])

    &gt;&gt;&gt; torch.max(a)

    tensor(0.7445)



.. function:: max(input, dim, keepdim=False, *, out=None) -&gt; (Tensor, LongTensor)

   :noindex:



Returns a namedtuple ``(values, indices)`` where ``values`` is the maximum

value of each row of the :attr:`input` tensor in the given dimension

:attr:`dim`. And ``indices`` is the index location of each maximum value found

(argmax).



If ``keepdim`` is ``True``, the output tensors are of the same size

as ``input`` except in the dimension ``dim`` where they are of size 1.

Otherwise, ``dim`` is squeezed (see :func:`torch.squeeze`), resulting

in the output tensors having 1 fewer dimension than ``input``.



.. note:: If there are multiple maximal values in a reduced row then

          the indices of the first maximal value are returned.



Args:

    input (Tensor): the input tensor.

    dim (int): the dimension to reduce.

    keepdim (bool): whether the output tensor has :attr:`dim` retained or not. Default: ``False``.



Keyword args:

    out (tuple, optional): the result tuple of two output tensors (max, max_indices)



Example::



    &gt;&gt;&gt; a = torch.randn(4, 4)

    &gt;&gt;&gt; a

    tensor([[-1.2360, -0.2942, -0.1222,  0.8475],

            [ 1.1949, -1.1127, -2.2379, -0.6702],

            [ 1.5717, -0.9207,  0.1297, -1.8768],

            [-0.6172,  1.0036, -0.6060, -0.2432]])

    &gt;&gt;&gt; torch.max(a, 1)

    torch.return_types.max(values=tensor([0.8475, 1.1949, 1.5717, 1.0036]), indices=tensor([3, 0, 0, 1]))



.. function:: max(input, other, *, out=None) -&gt; Tensor

   :noindex:



See :func:`torch.maximum`.

<span class="ansi-red-fg">Type:</span>      builtin_function_or_method</pre>
</div>
</div>
</div></div><div id="cell-28" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb17" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>torch.<span class="bu">max</span>(tensor([<span class="op">-</span><span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="op">-</span><span class="dv">4</span>]), tensor([<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre data-code-line-numbers=""><code>tensor([0, 2, 3, 0])</code></pre>
</div>
</div>
<div id="cell-29" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb19" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> relu(x): <span class="cf">return</span> torch.<span class="bu">max</span>(x, tensor([<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another way is to use <code>torch.clamp_min</code>, which is more idiomatic for this case.</p>
<div id="cell-31" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb20" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> relu(x): <span class="cf">return</span> x.clamp_min(<span class="fl">0.</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb21" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> lin(vld_x, w1, b1)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>test_eq(relu(t), F.relu(t))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A single neuron can now be constructed.</p>
<div id="cell-34" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb22" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model(xb):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  l1 <span class="op">=</span> relu(lin(xb, w1, b1))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> lin(l1, w2, b2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb23" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>res <span class="op">=</span> model(vld_x)<span class="op">;</span> res.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre data-code-line-numbers=""><code>torch.Size([1000, 1])</code></pre>
</div>
</div>
</section>
<section id="loss-function" class="level2">
<h2 class="anchored" data-anchor-id="loss-function">Loss Function</h2>
<p>With the forward pass being implemented, it is time to determine the loss. Even though we have a multi-class classification problem at hand, I will use mean squared error for simplicity. Later in this post, I will switch to cross entropy loss.</p>
<p>The Mean Squared Error (MSE) between two vectors can be represented as:</p>
<p><span class="math display">\[
\text{MSE} = \frac{\sum_{i=1}^{n} (y_i - x_i)^2}{n}
\]</span></p>
<p>where <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> are vectors of length <span class="math inline">\(n\)</span>, and <span class="math inline">\(x_i\)</span> and <span class="math inline">\(y_i\)</span> represent the <span class="math inline">\(i\)</span>-th elements of the vectors.</p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>MSE in its most basic form looks like this.</p>
<p><span class="math display">\[
\text{MSE} = \frac{(y - x)^2}{1}
\]</span></p>
<p>If we have multiple data points, then it looks like this.</p>
<p><span class="math display">\[
\text{MSE} = \frac{(y_1 - x_1)^2+(y_2 - x_2)^2+(y_3 - x_3)^2}{3}
\]</span></p>
</div>
</div>
</div>
<p>The tensor holding the predictions and the tensor holding the targets have different shapes. Therefore, there are different ways in which both can be subtracted from each other.</p>
<div id="cell-40" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb25" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>res.shape, vld_y.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre data-code-line-numbers=""><code>(torch.Size([1000, 1]), torch.Size([1000]))</code></pre>
</div>
</div>
<div id="cell-41" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb27" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(vld_y <span class="op">-</span> res).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre data-code-line-numbers=""><code>torch.Size([1000, 1000])</code></pre>
</div>
</div>
<div id="cell-42" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb29" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(vld_y[:, <span class="va">None</span>] <span class="op">-</span> res).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre data-code-line-numbers=""><code>torch.Size([1000, 1])</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb31" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>res[:, <span class="dv">0</span>].shape, res.squeeze().shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre data-code-line-numbers=""><code>(torch.Size([1000]), torch.Size([1000]))</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb33" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>(vld_y <span class="op">-</span> res[:, <span class="dv">0</span>]).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre data-code-line-numbers=""><code>torch.Size([1000])</code></pre>
</div>
</div>
<p>However, it will be better to add a column to <code>vld_y</code> rather than remove a column from <code>res</code>, so as to keep the shape of all tensors consistent (i.e., all tensors having a row and column, as opposed to some having rows and columns, and others having only a column).</p>
<div id="cell-46" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>((vld_y[:, <span class="va">None</span>] <span class="op">-</span> res)<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>() <span class="op">/</span> res.shape[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre data-code-line-numbers=""><code>tensor(717.17)</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb37" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mse(preds, targs): <span class="cf">return</span> (targs[:, <span class="va">None</span>] <span class="op">-</span> preds).<span class="bu">pow</span>(<span class="dv">2</span>).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> model(trn_x)<span class="op">;</span> mse(preds, trn_y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre data-code-line-numbers=""><code>tensor(648.87)</code></pre>
</div>
</div>
<div id="cell-49" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb40" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>test_eq(mse(preds, trn_y), F.mse_loss(preds, trn_y[:, <span class="va">None</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="backward-pass" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="backward-pass">Backward Pass</h2>
<p>Now comes the backward pass; the pass responsible for computing the gradients of our model’s weights.</p>
<p>For brevity, I will not explain why I compute the gradients the way I do. It can be taken that the way I compute them is due to the result of calculating the derivatives of the foward pass by hand. If you would like to explore how I did so, you can refer to my other blog post, <a href="../../forblog/posts/18_backprop_from_scratch.html">Backpropagation Explained using English Words*</a>.</p>
<p>In short, the derivatives compute to be the following.</p>
<div class="callout callout-style-simple callout-none no-icon">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-body-container">
<p><span class="math display">\[
\begin{align}
  \frac{\partial \text{MSE}}{\partial \vec{\rm{w}}_1} &amp;=
    \begin{cases}
      0 &amp; \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 ≤ 0 \\
      \frac{2}{N} \sum^N_{i=1} (\text{max}(0, \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1) \cdot \vec{\rm{w}}_2 + b_2 - \vec{\rm{y}}_i) \cdot \vec{\rm{w}}^T_2 \cdot \vec{\rm{x}}_i^T &amp; \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 &gt; 0
    \end{cases} \\
  \frac{\partial \text{MSE}}{\partial b_1} &amp;=
    \begin{cases}
      0 &amp; \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 ≤ 0 \\
      \frac{2}{N} \sum^N_{i=1} (\text{max}(0, \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1) \cdot \vec{\rm{w}}_2 + b_2 - \vec{\rm{y}}_i) \cdot \vec{\rm{w}}_2^T &amp; \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 &gt; 0
    \end{cases} \\
  \frac{\partial \text{MSE}}{\partial \vec{\rm{x}}_i} &amp;=
    \begin{cases}
      0 &amp; \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 ≤ 0 \\
      \frac{2}{N} \sum^N_{i=1} (\text{max}(0, \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1) \cdot \vec{\rm{w}}_2 + b_2 - \vec{\rm{y}}_i) \cdot \vec{\rm{w}}^T_2 \cdot \vec{\rm{w}}_1^T &amp; \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 &gt; 0
    \end{cases} \\
  \frac{\partial \text{MSE}}{\partial \vec{\rm{w}}_2} &amp;= \frac{2}{N} \sum^N_{i=1} (\text{max}(0, \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1) \cdot \vec{\rm{w}}_2 + b_2 - \vec{\rm{y}}_i) \cdot \text{max}(0, \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1) \\
  \frac{\partial \text{MSE}}{\partial b_2} &amp;= \frac{2}{N} \sum^N_{i=1} \text{max}(0, \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1) \cdot \vec{\rm{w}}_2 + b_2 - \vec{\rm{y}}_i
\end{align}
\]</span></p>
</div>
</div>
</div>
<p>When implementing backpropagation, it is better to implement the entire equation in pieces, by storing the result of each intermediate gradient. These intermediate gradients can then be reused to calculate the gradients of another variable.</p>
<p>Let’s prepare the pieces we’ll need and get started.</p>
<div id="cell-53" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb41" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>l1 <span class="op">=</span> relu(lin(trn_x, w1, b1))</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>l2 <span class="op">=</span> lin(l1, w2, b2)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mse(l2, trn_y)<span class="op">;</span> loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre data-code-line-numbers=""><code>tensor(648.87)</code></pre>
</div>
</div>
<section id="w1-gradients" class="level3">
<h3 class="anchored" data-anchor-id="w1-gradients"><code>w1</code> Gradients</h3>
<p>This is the maths to compute the gradients for <code>w1</code>, as also shown above.</p>
<p><span class="math display">\[
  \frac{\partial \text{MSE}}{\partial \vec{\rm{w}}_1} =
    \begin{cases}
      0 &amp; \text{if } \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 \leq 0 \\
      \frac{2}{N} \sum^N_{i=1} (\text{max}(0, \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1) \cdot \vec{\rm{w}}_2 + b_2 - \vec{\rm{y}}_i) \cdot \vec{\rm{w}}^T_2 \cdot \vec{\rm{x}}_i^T &amp; \text{if } \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 &gt; 0
    \end{cases}
\]</span></p>
<div class="callout callout-style-simple callout-note">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>Here, you can see the individual pieces I will compute to implement this equation.</p>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Substitutions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math display">\[
\begin{align}
    u_1 &amp;= \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 \\
    u_2 &amp;= \text{max}(0, u_1) \\
    u_3 &amp;= u_2 \cdot \vec{\rm{w}}_2 + b_2 \\
    u_4 &amp;= \vec{\rm{y}}_i - u_3 \\
    u_5 &amp;= u_4^2
\end{align}
\]</span></p>
</div>
</div>
</div>
<div class="callout callout-style-simple callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Derivatives of the Substitutions
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><span class="math display">\[
\begin{alignat}{4}
  \text{gradient of } u_4 &amp;= \frac{\partial u_5}{\partial u_4} &amp;&amp;=
  \frac{\partial}{\partial u_4} u_4^2 &amp;&amp;&amp;= 2u_4 \\
  \text{gradient of } u_3 &amp;= \frac{\partial u_4}{\partial u_3} &amp;&amp;= \frac{\partial}{\partial u_3} \vec{\rm{y}}_i - u_3 &amp;&amp;&amp;= -1 \\
  \text{gradient of } u_2 &amp;= \frac{\partial u_3}{\partial u_2} &amp;&amp;= \frac{\partial}{\partial u_2} u_2 \cdot \vec{\rm{w}}_2 + b_2 &amp;&amp;&amp;= \vec{\rm{w}}^T_2 \\
  \text{gradient of } u_1 &amp;= \frac{\partial \vec{\rm{u}}_2}{\partial \vec{\rm{u}}_1} &amp;&amp;= \frac{\partial}{\partial u_1} \text{max}(0, u_1) &amp;&amp;&amp;=
    \begin{cases}
      0 &amp; \vec{\rm{u}}_1 ≤ 0 \\
      1 &amp; \vec{\rm{u}}_1 &gt; 0
    \end{cases} \\
  \text{gradient of } \vec{\rm{w}}_1 &amp;= \frac{\partial u_1}{\partial \vec{\rm{w}}_1} &amp;&amp;= \frac{\partial}{\partial w_1} \vec{\rm{x}}_i \cdot \vec{\rm{w}}_1 + b_1 &amp;&amp;&amp;= \vec{\rm{x}}^T_i
\end{alignat}
\]</span></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="cell-56" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb43" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> trn_y[:, <span class="va">None</span>] <span class="op">-</span> l2<span class="op">;</span> diff.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre data-code-line-numbers=""><code>torch.Size([1000, 1])</code></pre>
</div>
</div>
<div id="cell-57" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb45" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>loss.g <span class="op">=</span> (<span class="dv">2</span><span class="op">/</span>n) <span class="op">*</span> diff<span class="op">;</span> loss, loss.g.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre data-code-line-numbers=""><code>(tensor(648.87), torch.Size([1000, 1]))</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb47" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>diff.g <span class="op">=</span> <span class="op">-</span><span class="dv">1</span> <span class="op">*</span> loss.g<span class="op">;</span> diff[:<span class="dv">5</span>], diff.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre data-code-line-numbers=""><code>(tensor([[-15.34],
         [-33.46],
         [-35.26],
         [ -6.92],
         [-21.55]]),
 torch.Size([1000, 1]))</code></pre>
</div>
</div>
<div id="cell-59" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb49" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(w2.shape, diff.g.shape), (w2.T.shape, diff.g[:, <span class="va">None</span>].shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre data-code-line-numbers=""><code>((torch.Size([50, 1]), torch.Size([1000, 1])),
 (torch.Size([1, 50]), torch.Size([1000, 1, 1])))</code></pre>
</div>
</div>
<div id="cell-60" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb51" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(diff.g <span class="op">@</span> w2.T).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre data-code-line-numbers=""><code>torch.Size([1000, 50])</code></pre>
</div>
</div>
<div id="cell-61" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb53" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>l2.g <span class="op">=</span> diff.g <span class="op">@</span> w2.T<span class="op">;</span> l2.g.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre data-code-line-numbers=""><code>torch.Size([1000, 50])</code></pre>
</div>
</div>
<div id="cell-62" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb55" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(l1 <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre data-code-line-numbers=""><code>tensor([[0., 1., 1.,  ..., 0., 0., 0.],
        [0., 0., 1.,  ..., 1., 0., 0.],
        [1., 1., 1.,  ..., 0., 0., 1.],
        ...,
        [0., 0., 0.,  ..., 0., 1., 0.],
        [1., 1., 0.,  ..., 0., 0., 1.],
        [0., 0., 1.,  ..., 0., 0., 0.]])</code></pre>
</div>
</div>
<div id="cell-63" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb57" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>l1.g <span class="op">=</span> l2.g <span class="op">*</span> (l1 <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()<span class="op">;</span> l1.g.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre data-code-line-numbers=""><code>torch.Size([1000, 50])</code></pre>
</div>
</div>
<div id="cell-64" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb59" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>(l1.g.shape, trn_x.shape), (l1.g[:, <span class="va">None</span>, :].shape, trn_x[..., <span class="va">None</span>].shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre data-code-line-numbers=""><code>((torch.Size([1000, 50]), torch.Size([1000, 784])),
 (torch.Size([1000, 1, 50]), torch.Size([1000, 784, 1])))</code></pre>
</div>
</div>
<div id="cell-65" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb61" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>w1.g <span class="op">=</span> tensor([<span class="dv">1</span>, <span class="dv">2</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-66" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb62" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>w1.g <span class="op">=</span> (l1.g[:, <span class="va">None</span>, :] <span class="op">*</span> trn_x[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)<span class="op">;</span> w1.g.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre data-code-line-numbers=""><code>torch.Size([784, 50])</code></pre>
</div>
</div>
<div id="cell-67" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb64" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>(w1.shape, w1.g.shape), (w1.g.<span class="bu">min</span>(), w1.g.<span class="bu">max</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre data-code-line-numbers=""><code>((torch.Size([784, 50]), torch.Size([784, 50])),
 (tensor(-17.50), tensor(25.09)))</code></pre>
</div>
</div>
<p>Let’s verify our derivation is correct by comparing it to the gradients computed by PyTorch.</p>
<div id="cell-69" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb66" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>w1_ <span class="op">=</span> w1.clone().requires_grad_()<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-70" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb67" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>l1 <span class="op">=</span> relu(lin(trn_x, w1_, b1))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>l2 <span class="op">=</span> lin(l1, w2, b2)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mse(l2, trn_y)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-71" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb68" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>w1_.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre data-code-line-numbers=""><code>tensor([[0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.],
        ...,
        [0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.]])</code></pre>
</div>
</div>
<div id="cell-72" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb70" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>(w1.g.<span class="bu">min</span>(), w1.g.<span class="bu">max</span>()), (w1_.grad.<span class="bu">min</span>(), w1_.grad.<span class="bu">max</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre data-code-line-numbers=""><code>((tensor(-17.50), tensor(25.09)), (tensor(-17.50), tensor(25.09)))</code></pre>
</div>
</div>
<div id="cell-73" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb72" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>test_close(w1.g, w1_.grad, eps<span class="op">=</span><span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is!</p>
</section>
<section id="b1-gradients" class="level3">
<h3 class="anchored" data-anchor-id="b1-gradients"><code>b1</code> Gradients</h3>
<p>As previously mentioned, I can reuse the computed gradients to calculate the gradients for <span class="math inline">\(b_1\)</span>. For now though, I will show the entire implemention for easy reference and later, when we will encapsulate the backward pass, I will reuse the already computed gradients.</p>
<div id="cell-77" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb73" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> trn_y[:, <span class="va">None</span>] <span class="op">-</span> l2</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>loss.g <span class="op">=</span> (<span class="dv">2</span><span class="op">/</span>n) <span class="op">*</span> diff</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>diff.g <span class="op">=</span> loss.g <span class="op">*</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>l2.g <span class="op">=</span> diff.g <span class="op">@</span> w2.T</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>l1.g <span class="op">=</span> l2.g <span class="op">*</span> (l1 <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>l1.g.shape, b1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre data-code-line-numbers=""><code>(torch.Size([1000, 50]), torch.Size([50]))</code></pre>
</div>
</div>
<div id="cell-78" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb75" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>b1.g <span class="op">=</span> (l1.g <span class="op">*</span> <span class="dv">1</span>).<span class="bu">sum</span>(<span class="dv">0</span>)<span class="op">;</span> b1.g.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre data-code-line-numbers=""><code>torch.Size([50])</code></pre>
</div>
</div>
<div id="cell-79" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb77" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>b1.<span class="bu">min</span>(), b1.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre data-code-line-numbers=""><code>(tensor(0.), tensor(0.))</code></pre>
</div>
</div>
</section>
<section id="trn_x-gradients" class="level3">
<h3 class="anchored" data-anchor-id="trn_x-gradients"><code>trn_x</code> Gradients</h3>
<div id="cell-81" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb79" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> trn_y[:, <span class="va">None</span>] <span class="op">-</span> l2</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>loss.g <span class="op">=</span> (<span class="dv">2</span><span class="op">/</span>n) <span class="op">*</span> diff</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>diff.g <span class="op">=</span> loss.g <span class="op">*</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>l2.g <span class="op">=</span> diff.g <span class="op">@</span> w2.T</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>l1.g <span class="op">=</span> l2.g <span class="op">*</span> (l1 <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>l1.g.shape, w1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre data-code-line-numbers=""><code>(torch.Size([1000, 50]), torch.Size([784, 50]))</code></pre>
</div>
</div>
<div id="cell-82" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb81" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>trn_x.g <span class="op">=</span> l1.g <span class="op">@</span> w1.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb82" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>trn_x.g.<span class="bu">min</span>(), trn_x.g.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">
<pre data-code-line-numbers=""><code>(tensor(-2.85, grad_fn=&lt;MinBackward1&gt;), tensor(2.85, grad_fn=&lt;MaxBackward1&gt;))</code></pre>
</div>
</div>
</section>
<section id="w1-gradients-1" class="level3">
<h3 class="anchored" data-anchor-id="w1-gradients-1"><code>w1</code> Gradients</h3>
<div id="cell-85" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb84" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> trn_y[:, <span class="va">None</span>] <span class="op">-</span> l2</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>loss.g <span class="op">=</span> (<span class="dv">2</span><span class="op">/</span>n) <span class="op">*</span> diff</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>diff.g <span class="op">=</span> loss.g <span class="op">*</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>diff.g.shape, l1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre data-code-line-numbers=""><code>(torch.Size([1000, 1]), torch.Size([1000, 50]))</code></pre>
</div>
</div>
<div id="cell-86" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb86" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>(diff.g <span class="op">*</span> l1).<span class="bu">sum</span>(<span class="dv">0</span>, keepdim<span class="op">=</span><span class="va">True</span>).T.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre data-code-line-numbers=""><code>torch.Size([50, 1])</code></pre>
</div>
</div>
<div id="cell-87" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb88" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>(diff.g[:, <span class="va">None</span>, :] <span class="op">*</span> l1[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre data-code-line-numbers=""><code>torch.Size([50, 1])</code></pre>
</div>
</div>
<div id="cell-88" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb90" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>w2.g <span class="op">=</span> (diff.g[:, <span class="va">None</span>, :] <span class="op">*</span> l1[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)<span class="op">;</span> w2.g.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">
<pre data-code-line-numbers=""><code>torch.Size([50, 1])</code></pre>
</div>
</div>
<div id="cell-89" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb92" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>w2.g.<span class="bu">min</span>(), w2.g.<span class="bu">max</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre data-code-line-numbers=""><code>(tensor(8.37, grad_fn=&lt;MinBackward1&gt;), tensor(388.44, grad_fn=&lt;MaxBackward1&gt;))</code></pre>
</div>
</div>
</section>
<section id="b2-gradients" class="level3">
<h3 class="anchored" data-anchor-id="b2-gradients"><code>b2</code> Gradients</h3>
<div id="cell-91" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb94" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>diff <span class="op">=</span> trn_y[:, <span class="va">None</span>] <span class="op">-</span> l2</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>loss.g <span class="op">=</span> (<span class="dv">2</span><span class="op">/</span>n) <span class="op">*</span> diff</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>diff.g <span class="op">=</span> loss.g <span class="op">*</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>b2.g <span class="op">=</span> (diff.g <span class="op">*</span> <span class="dv">1</span>).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>b2.g.shape, b2.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre data-code-line-numbers=""><code>(torch.Size([1]), torch.Size([1]))</code></pre>
</div>
</div>
</section>
<section id="verify" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="verify">Verify</h3>
<p>Let’s verify our remaining gradients.</p>

<div class="no-row-height column-margin column-container"><div id="cell-94" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb96" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>w1_, b1_, w2_, b2_, trn_x_ <span class="op">=</span> [<span class="kw">lambda</span> w: w.clone.requires_grad_() <span class="cf">for</span> w <span class="kw">in</span> [w1, b1, w2, b2, trn_x]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="">
<p>The expression above does not work to create copies. Rather than returning a cloned copy that requires gradients, lambda objects will be returned.</p>
</div></div>
<div id="cell-96" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb97" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>w1_, b1_, w2_, b2_, trn_x_ <span class="op">=</span> <span class="bu">map</span>(<span class="kw">lambda</span> w: w.clone().requires_grad_(), [w1, b1, w2, b2, trn_x])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-97" class="cell page-columns page-full" data-execution_count="60">

<div class="no-row-height column-margin column-container"><div class="cell-output cell-output-display" data-execution_count="60">
<pre data-code-line-numbers=""><code>tensor([[-2.81, -1.72, -0.97,  ..., -0.29, -1.62, -0.45],
        [-1.77, -0.17,  1.32,  ..., -0.92,  0.76,  2.77],
        [ 0.58,  2.13, -0.98,  ...,  0.41,  1.50,  0.86],
        ...,
        [-0.50, -1.90, -0.10,  ..., -1.61,  0.78, -0.09],
        [ 0.89,  0.50,  1.21,  ...,  0.93, -0.37, -0.85],
        [ 0.57, -0.50, -1.47,  ...,  0.72,  1.64, -0.85]], requires_grad=True)</code></pre>
</div></div></div>
<div id="cell-98" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb99" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>w1_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre data-code-line-numbers=""><code>tensor([[-2.81, -1.72, -0.97,  ..., -0.29, -1.62, -0.45],
        [-1.77, -0.17,  1.32,  ..., -0.92,  0.76,  2.77],
        [ 0.58,  2.13, -0.98,  ...,  0.41,  1.50,  0.86],
        ...,
        [-0.50, -1.90, -0.10,  ..., -1.61,  0.78, -0.09],
        [ 0.89,  0.50,  1.21,  ...,  0.93, -0.37, -0.85],
        [ 0.57, -0.50, -1.47,  ...,  0.72,  1.64, -0.85]], requires_grad=True)</code></pre>
</div>
</div>
<div id="cell-99" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb101" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>l1 <span class="op">=</span> relu(lin(trn_x_, w1_, b1_))</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>l2 <span class="op">=</span> lin(l1, w2_, b2_)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> mse(l2, trn_y)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-100" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb102" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> a, b <span class="kw">in</span> <span class="bu">zip</span>((w1, b1, w2, b2, trn_x), (w1_, b1_, w2_, b2_, trn_x_)): test_close(a.g, b.grad, eps<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All comparisons passed!</p>
</section>
</section>
<section id="encapsulate" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="encapsulate">Encapsulate</h2>
<p>Now that we have the forward and backward passes sorted, let us cohesively bring them together.</p>
<div id="cell-104" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb103" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forward(inps, targs):</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  l1 <span class="op">=</span> relu(lin(inps, w1, b1))</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  l2 <span class="op">=</span> lin(l1, w2, b2)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  loss <span class="op">=</span> mse(l2, targs)</span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> l1, l2, loss</span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backward(inps, targs, l1, l2, loss):</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  diff <span class="op">=</span> targs[:, <span class="va">None</span>] <span class="op">-</span> l2</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  loss.g <span class="op">=</span> (<span class="dv">2</span> <span class="op">/</span> n) <span class="op">*</span> diff</span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a>  diff.g <span class="op">=</span> loss.g <span class="op">*</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>  w2.g <span class="op">=</span> (diff.g[:, <span class="va">None</span>, :] <span class="op">*</span> l1[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a>  b2.g <span class="op">=</span> (diff.g <span class="op">*</span> <span class="dv">1</span>).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>  l2.g <span class="op">=</span> diff.g <span class="op">@</span> w2.T</span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>  l1.g <span class="op">=</span> l2.g <span class="op">*</span> (l1 <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>  w1.g <span class="op">=</span> (l1.g[:, <span class="va">None</span>, :] <span class="op">*</span> trn_x[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>  b1.g <span class="op">=</span> (l1.g <span class="op">*</span> <span class="dv">1</span>).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>  inps.g <span class="op">=</span> l1.g <span class="op">@</span> w1.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-105" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb104" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>l1, l2, loss <span class="op">=</span> forward(trn_x, trn_y)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>backward(trn_x, trn_y, l1, l2, loss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-106" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb105" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> comp_grads(<span class="op">*</span>ws):</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> a, b <span class="kw">in</span> <span class="bu">zip</span>(ws, (w1_, b1_, w2_, b2_, trn_x_)): test_close(a.g, b.grad, eps<span class="op">=</span><span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-107" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb106" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>comp_grads(w1, b1, w2, b2, trn_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>backward</code> function can be further refactored by taking the gradient computations of the linear layers common.</p>
<div id="cell-109" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb107" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backward(inps, targs, l1, l2, loss):</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>  diff <span class="op">=</span> targs[:, <span class="va">None</span>] <span class="op">-</span> l2</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  loss.g <span class="op">=</span> (<span class="dv">2</span><span class="op">/</span>n) <span class="op">*</span> diff</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  diff.g <span class="op">=</span> loss.g <span class="op">*</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>  lin_grad(l1, diff, w2, b2)</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>  l2.g <span class="op">=</span> diff.g <span class="op">@</span> w2.T</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  l1.g <span class="op">=</span> l2.g <span class="op">*</span> (l1 <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>  lin_grad(inps, l1, w1, b1)</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lin_grad(inp, out, w, b):</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>  inp.g <span class="op">=</span> out.g <span class="op">@</span> w.T</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>  w.g <span class="op">=</span> (out.g[:, <span class="va">None</span>, :] <span class="op">*</span> inp[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>  b.g <span class="op">=</span> (out.g <span class="op">*</span> <span class="dv">1</span>).<span class="bu">sum</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Previous implementation.</p>
<div class="sourceCode" id="cb108" data-code-line-numbers=""><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backward(inps, targs, l1, l2, loss):</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  diff <span class="op">=</span> targs[:, <span class="va">None</span>] <span class="op">-</span> l2</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  loss.g <span class="op">=</span> (<span class="dv">2</span> <span class="op">/</span> n) <span class="op">*</span> diff</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  diff.g <span class="op">=</span> loss.g <span class="op">*</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  w2.g <span class="op">=</span> (diff.g[:, <span class="va">None</span>, :] <span class="op">*</span> l1[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>  b2.g <span class="op">=</span> (diff.g <span class="op">*</span> <span class="dv">1</span>).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  l2.g <span class="op">=</span> diff.g <span class="op">@</span> w2.T</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>  l1.g <span class="op">=</span> l2.g <span class="op">*</span> (l1 <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>  w1.g <span class="op">=</span> (l1.g[:, <span class="va">None</span>, :] <span class="op">*</span> trn_x[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>  b1.g <span class="op">=</span> (l1.g <span class="op">*</span> <span class="dv">1</span>).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>  inps.g <span class="op">=</span> l1.g <span class="op">@</span> w1.T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div><div id="cell-111" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb109" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>backward(trn_x, trn_y, <span class="op">*</span>forward(trn_x, trn_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-112" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb110" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>comp_grads(w1, b1, w2, b2, trn_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="class" class="level3">
<h3 class="anchored" data-anchor-id="class">Class</h3>
<p>Currently, we have functions that each separately handle a part of the network. For instance, <code>mse</code> only computes its respective portion of the forward pass: the mean squared error. <code>backward</code> is a separate function that handles the backward pass for all pieces of the network.</p>
<p>Let us change how this works, so each piece of the network also handles its respective backward pass. This means, <code>mse</code> will have the ability to compute both its forward pass and backward pass.</p>
<div id="cell-115" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb111" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MSE:</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp, targs):</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.inp,<span class="va">self</span>.targs <span class="op">=</span> inp,targs</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.out <span class="op">=</span> (inp[:, <span class="dv">0</span>] <span class="op">-</span> targs).<span class="bu">pow</span>(<span class="dv">2</span>).mean()</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> backward(<span class="va">self</span>): <span class="va">self</span>.inp.g <span class="op">=</span> (<span class="dv">2</span> <span class="op">/</span> <span class="va">self</span>.inp.shape[<span class="dv">0</span>]) <span class="op">*</span> (<span class="va">self</span>.inp[:, <span class="dv">0</span>] <span class="op">-</span> <span class="va">self</span>.targs)[..., <span class="va">None</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-116" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb112" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>test_eq(MSE()(preds, trn_y), mse(preds, trn_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-117" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb113" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Lin:</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, w, b): <span class="va">self</span>.w,<span class="va">self</span>.b <span class="op">=</span> w,b</span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp):</span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.inp <span class="op">=</span> inp</span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.out <span class="op">=</span> <span class="va">self</span>.inp <span class="op">@</span> <span class="va">self</span>.w <span class="op">+</span> <span class="va">self</span>.b</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> backward(<span class="va">self</span>):</span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.inp.g <span class="op">=</span> <span class="va">self</span>.out.g <span class="op">@</span> <span class="va">self</span>.w.T</span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.w.g <span class="op">=</span> (<span class="va">self</span>.out.g[:, <span class="va">None</span>, :] <span class="op">*</span> <span class="va">self</span>.inp[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.b.g <span class="op">=</span> <span class="va">self</span>.out.g.<span class="bu">sum</span>(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-118" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb114" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>test_eq(Lin(w1, b1)(trn_x), lin(trn_x, w1, b1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-119" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb115" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ReLU:</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp):</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.inp <span class="op">=</span> inp</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.out <span class="op">=</span> <span class="va">self</span>.inp.clamp_min(<span class="fl">0.</span>)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> backward(<span class="va">self</span>): <span class="va">self</span>.inp.g <span class="op">=</span> <span class="va">self</span>.out.g <span class="op">*</span> (<span class="va">self</span>.inp <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-120" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb116" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>test_eq(ReLU()(l1), relu(l1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-121" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb117" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model:</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, w1, b1, w2, b2):</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.layers <span class="op">=</span> [Lin(w1, b1), ReLU(), Lin(w2, b2)]</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.loss <span class="op">=</span> MSE()</span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp, targs):</span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers: inp <span class="op">=</span> l(inp)</span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.loss(inp, targs)</span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> backward(<span class="va">self</span>):</span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.loss.backward()</span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers[::<span class="op">-</span><span class="dv">1</span>]: l.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-122" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb118" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(w1, b1, w2, b2)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>l <span class="op">=</span> model(trn_x, trn_y)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>model.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-123" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb119" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>comp_grads(w1, b1, w2, b2, trn_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="super-class" class="level3">
<h3 class="anchored" data-anchor-id="super-class">Super Class</h3>
<p>The classes we have created have common functionality, meaning their is still room for further refactoring. In particular, all the classes store the forward pass arguments as attributes if needed, have a <code>__call__</code> dunder method that exectutes the forward pass, and a <code>backward</code> method for the backward pass.</p>
<div id="cell-126" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb120" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Module():</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, <span class="op">*</span>args):</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.args <span class="op">=</span> args</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.out <span class="op">=</span> <span class="va">self</span>.forward(<span class="op">*</span>args)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.out</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>): <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">'Forward pass not implemented'</span>)</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> backward(<span class="va">self</span>): <span class="va">self</span>.bwd(<span class="va">self</span>.out, <span class="op">*</span><span class="va">self</span>.args)</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> bwd(<span class="va">self</span>): <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">'Backward pass not implemented.'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-127" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb121" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MSE(Module):</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, inp, targs): <span class="cf">return</span> (inp[:, <span class="dv">0</span>] <span class="op">-</span> targs).<span class="bu">pow</span>(<span class="dv">2</span>).mean()</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> bwd(<span class="va">self</span>, out, inp, targs): inp.g <span class="op">=</span> (<span class="dv">2</span> <span class="op">/</span> inp.shape[<span class="dv">0</span>]) <span class="op">*</span> (inp[:, <span class="dv">0</span>] <span class="op">-</span> targs)[..., <span class="va">None</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-128" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb122" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>test_eq(MSE()(preds, trn_y), mse(preds, trn_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-129" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb123" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Lin(Module):</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, w, b): <span class="va">self</span>.w,<span class="va">self</span>.b <span class="op">=</span> w,b</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, inp): <span class="cf">return</span> inp <span class="op">@</span> <span class="va">self</span>.w <span class="op">+</span> <span class="va">self</span>.b</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> bwd(<span class="va">self</span>, out, inp):</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    inp.g <span class="op">=</span> out.g <span class="op">@</span> <span class="va">self</span>.w.T</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.w.g <span class="op">=</span> (out.g[:, <span class="va">None</span>, :] <span class="op">*</span> inp[..., <span class="va">None</span>]).<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.b.g <span class="op">=</span> out.g.<span class="bu">sum</span>(<span class="dv">0</span>)</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-130" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb124" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>test_eq(Lin(w1, b1)(trn_x), lin(trn_x, w1, b1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-131" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb125" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ReLU(Module):</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, inp): <span class="cf">return</span> inp.clamp_min(<span class="fl">0.</span>)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> bwd(<span class="va">self</span>, out, inp): inp.g <span class="op">=</span> out.g <span class="op">*</span> (inp <span class="op">&gt;</span> <span class="dv">0</span>).<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-132" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb126" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>test_eq(ReLU()(l1), relu(l1))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-133" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb127" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(w1, b1, w2, b2)</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> model(trn_x, trn_y)</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>model.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-134" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb128" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>comp_grads(w1, b1, w2, b2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And with that, this is the basic underlying paradigm in which PyTorch implements its components.</p>
<p>So let us now directly use PyTorch’s <code>nn.Module</code> to handle our components. There is an added benefit that <code>nn.Module</code> automatically keeps track of our gradients, so we do not need to implement the backward pass.</p>
</section>
<section id="pytorchs-nn.module" class="level3">
<h3 class="anchored" data-anchor-id="pytorchs-nn.module">PyTorch’s <code>nn.Module</code></h3>
<div id="cell-137" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb129" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>w1.shape, n, m, c, b1.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="89">
<pre data-code-line-numbers=""><code>(torch.Size([784, 50]), 1000, 784, tensor(10), torch.Size([50]))</code></pre>
</div>
</div>
<div id="cell-138" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb131" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Linear(nn.Module):</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inps, n_outs):</span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.w <span class="op">=</span> torch.randn(n_inps, n_outs).requires_grad_()</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.b <span class="op">=</span> torch.randn(n_outs).requires_grad_()</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, inp): <span class="cf">return</span> inp <span class="op">@</span> <span class="va">self</span>.w <span class="op">+</span> <span class="va">self</span>.b</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-139" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb132" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>F <span class="op">=</span> nn.functional</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inp, nh, n_out):</span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.layers <span class="op">=</span> [Linear(n_inp, nh), nn.ReLU(), Linear(nh, n_out)]</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, inp, targ):</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers: inp <span class="op">=</span> l(inp)</span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> F.mse_loss(inp, targ[:, <span class="va">None</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-140" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb133" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(m, nh, <span class="dv">1</span>)</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> model(trn_x, trn_y.<span class="bu">float</span>())</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>loss.backward()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-141" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb134" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>model.layers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre data-code-line-numbers=""><code>[Linear(), ReLU(), Linear()]</code></pre>
</div>
</div>
<div id="cell-142" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb136" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>l0 <span class="op">=</span> model.layers[<span class="dv">0</span>]<span class="op">;</span> l0.b.grad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre data-code-line-numbers=""><code>tensor([ 42.11, -25.91,   0.15,  15.73, -16.16,  41.61,  13.73,  81.32,  -8.91,  55.30, -14.12, -82.24,  12.02, -27.58,  -9.48, -90.85,
        -25.55,  34.89,  -0.68, -14.24,   4.73,  49.70, -27.02,  19.55,  10.14,  38.86,  30.55,  74.17,   2.15,  -2.62, -37.11,  14.04,
        -12.12,   0.89,  -0.99,  -6.29,  -1.15,  12.26,  -9.73,  -4.13,  -1.53,   1.67,   1.34,  -9.78,  20.50,   7.30,  62.45,   5.94,
         -3.28, -18.14])</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="cross-entropy-loss" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="cross-entropy-loss">Cross Entropy Loss</h2>
<p>Let’s now implement a much more appropriate loss function for our multi-target problem: cross entropy loss.</p>
<div id="cell-146" class="cell" data-execution_count="95">
<details class="code-fold">
<summary>Redefinition of <code>Model</code>, but without with loss function.</summary>
<div class="sourceCode cell-code" id="cb138" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inps, nh, n_outs):</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.layers <span class="op">=</span> [nn.Linear(n_inps, nh), nn.ReLU(), nn.Linear(nh, n_outs)]</span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, x):</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>.layers: x <span class="op">=</span> l(x)</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-147" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb139" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(m, nh, c)</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> model(trn_x)<span class="op">;</span> preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre data-code-line-numbers=""><code>torch.Size([1000, 10])</code></pre>
</div>
</div>
<p>As I have defined <a href="../../dictionary/terms/cross_entropy_loss.html">here</a>, cross entropy loss simply involves taking the logarithm of the softmax function, and multiplying the results with the <a href="../../dictionary/terms/one_hot_encoding.html">one hot encoded</a> targets.</p>
<p><a href="../../dictionary/terms/softmax.html">Softmax</a>, a multi-class generalization of the sigmoid function, involves taking the exponent of each prediction, and dividing each resulting value with the sum of all predictions to the exponent.</p>
<p><span class="math display">\[
\text{S}(y_i) = \frac{e^{y_i}}{\sum_{j} e^{y_j}}
\]</span></p>
<div class="callout callout-style-simple callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Sigmoid Function Definition
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[
\sigma(y) = \frac{1}{1 + e^{-y}}
\]</span></p>
</div>
</div>
<p>Let’s begin by first taking the logarithm of the softmax function.</p>
<div id="cell-149" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb141" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_softmax(x): <span class="cf">return</span> ((x.exp() <span class="op">/</span> x.exp().<span class="bu">sum</span>(<span class="op">-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>))).log()</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>log_softmax(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre data-code-line-numbers=""><code>tensor([[-2.40, -2.33, -2.25,  ..., -2.33, -2.40, -2.34],
        [-2.37, -2.44, -2.21,  ..., -2.30, -2.34, -2.28],
        [-2.37, -2.45, -2.16,  ..., -2.24, -2.40, -2.40],
        ...,
        [-2.36, -2.45, -2.20,  ..., -2.24, -2.39, -2.37],
        [-2.34, -2.41, -2.28,  ..., -2.20, -2.53, -2.25],
        [-2.43, -2.37, -2.21,  ..., -2.26, -2.40, -2.37]], grad_fn=&lt;LogBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-150" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb143" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>F.log_softmax(preds, dim<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre data-code-line-numbers=""><code>tensor([[-2.40, -2.33, -2.25,  ..., -2.33, -2.40, -2.34],
        [-2.37, -2.44, -2.21,  ..., -2.30, -2.34, -2.28],
        [-2.37, -2.45, -2.16,  ..., -2.24, -2.40, -2.40],
        ...,
        [-2.36, -2.45, -2.20,  ..., -2.24, -2.39, -2.37],
        [-2.34, -2.41, -2.28,  ..., -2.20, -2.53, -2.25],
        [-2.43, -2.37, -2.21,  ..., -2.26, -2.40, -2.37]], grad_fn=&lt;LogSoftmaxBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-151" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb145" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>test_close(log_softmax(preds).detach(), F.log_softmax(preds, dim<span class="op">=-</span><span class="dv">1</span>).detach())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our implementation involves division. According to the rule, <span class="math inline">\(\lg\left(\frac{a}{b}\right) = \lg(a) - \lg(b)\)</span>, we can simplify our computation by subtracting the numerators and denominators instead.</p>
<div id="cell-153" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb146" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_softmax(x): <span class="cf">return</span> x.exp().log() <span class="op">-</span> x.exp().<span class="bu">sum</span>(<span class="op">-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>).log()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-154" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb147" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>log_softmax(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre data-code-line-numbers=""><code>tensor([[-2.40, -2.33, -2.25,  ..., -2.33, -2.40, -2.34],
        [-2.37, -2.44, -2.21,  ..., -2.30, -2.34, -2.28],
        [-2.37, -2.45, -2.16,  ..., -2.24, -2.40, -2.40],
        ...,
        [-2.36, -2.45, -2.20,  ..., -2.24, -2.39, -2.37],
        [-2.34, -2.41, -2.28,  ..., -2.20, -2.53, -2.25],
        [-2.43, -2.37, -2.21,  ..., -2.26, -2.40, -2.37]], grad_fn=&lt;SubBackward0&gt;)</code></pre>
</div>
</div>
<p>Our implementation has an issue though: it is unstable. Anything involving exponents is inherently unstable. Have a large enough value, and we converge to infinity relatively quickly.</p>
<div id="cell-156" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb149" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">101</span>, <span class="dv">10</span>): <span class="bu">print</span>(<span class="ss">f'e^</span><span class="sc">{</span>x<span class="sc">}</span><span class="ss">=</span><span class="sc">{</span>torch<span class="sc">.</span>exp(tensor(x))<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>e^0=1.0
e^10=22026.46484375
e^20=485165184.0
e^30=10686474223616.0
e^40=2.353852703404196e+17
e^50=5.184705457665547e+21
e^60=1.1420073962419164e+26
e^70=2.515438700355918e+30
e^80=5.540622484676759e+34
e^90=inf
e^100=inf</code></pre>
</div>
</div>
<p>Fortunately, there is trick to overcoming this known as the LogSumExp simplification.</p>
<p><span class="math display">\[
\lg\left(\sum^n_{j=1} e^{x_j}\right) = \lg\left(e^a \sum^n_{j=1} \frac{e^{x_j}}{e^a}\right) = \lg\left(e^a \sum^n_{j=1} e^{x_j - a}\right) = a + \lg\left(\sum^n_{j=1} e^{x_j - a}\right)
\]</span></p>
<p><span class="math inline">\(a\)</span> is the largest element in <span class="math inline">\(x\)</span>.</p>
<p>To begin, we need to get the largest value in each sample.</p>
<div id="cell-158" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb151" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="bu">max</span> <span class="op">=</span> preds.<span class="bu">max</span>(<span class="op">-</span><span class="dv">1</span>)[<span class="dv">0</span>]<span class="op">;</span> <span class="bu">max</span>.shape, preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="103">
<pre data-code-line-numbers=""><code>(torch.Size([1000]), torch.Size([1000, 10]))</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div id="cell-159" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb153" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>?torch.<span class="bu">max</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Docstring:</span>

max(input) -&gt; Tensor



Returns the maximum value of all elements in the ``input`` tensor.



.. warning::

    This function produces deterministic (sub)gradients unlike ``max(dim=0)``



Args:

    input (Tensor): the input tensor.



Example::



    &gt;&gt;&gt; a = torch.randn(1, 3)

    &gt;&gt;&gt; a

    tensor([[ 0.6763,  0.7445, -2.2369]])

    &gt;&gt;&gt; torch.max(a)

    tensor(0.7445)



.. function:: max(input, dim, keepdim=False, *, out=None) -&gt; (Tensor, LongTensor)

   :noindex:



Returns a namedtuple ``(values, indices)`` where ``values`` is the maximum

value of each row of the :attr:`input` tensor in the given dimension

:attr:`dim`. And ``indices`` is the index location of each maximum value found

(argmax).



If ``keepdim`` is ``True``, the output tensors are of the same size

as ``input`` except in the dimension ``dim`` where they are of size 1.

Otherwise, ``dim`` is squeezed (see :func:`torch.squeeze`), resulting

in the output tensors having 1 fewer dimension than ``input``.



.. note:: If there are multiple maximal values in a reduced row then

          the indices of the first maximal value are returned.



Args:

    input (Tensor): the input tensor.

    dim (int): the dimension to reduce.

    keepdim (bool): whether the output tensor has :attr:`dim` retained or not. Default: ``False``.



Keyword args:

    out (tuple, optional): the result tuple of two output tensors (max, max_indices)



Example::



    &gt;&gt;&gt; a = torch.randn(4, 4)

    &gt;&gt;&gt; a

    tensor([[-1.2360, -0.2942, -0.1222,  0.8475],

            [ 1.1949, -1.1127, -2.2379, -0.6702],

            [ 1.5717, -0.9207,  0.1297, -1.8768],

            [-0.6172,  1.0036, -0.6060, -0.2432]])

    &gt;&gt;&gt; torch.max(a, 1)

    torch.return_types.max(values=tensor([0.8475, 1.1949, 1.5717, 1.0036]), indices=tensor([3, 0, 0, 1]))



.. function:: max(input, other, *, out=None) -&gt; Tensor

   :noindex:



See :func:`torch.maximum`.

<span class="ansi-red-fg">Type:</span>      builtin_function_or_method</pre>
</div>
</div>
</div></div><p>Then we can simply implement the rest of the algorithm.</p>
<div id="cell-161" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb154" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>(preds <span class="op">-</span> <span class="bu">max</span>[..., <span class="va">None</span>]).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="105">
<pre data-code-line-numbers=""><code>torch.Size([1000, 10])</code></pre>
</div>
</div>
<div id="cell-162" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb156" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output hidden to prevent endless scrolling.</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="bu">max</span>[..., <span class="va">None</span>] <span class="op">+</span> (preds <span class="op">-</span> <span class="bu">max</span>[..., <span class="va">None</span>]).exp().<span class="bu">sum</span>(<span class="op">-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>).log()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-163" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb157" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>test_close(torch.exp(preds).<span class="bu">sum</span>(<span class="op">-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>).log(), <span class="bu">max</span>[..., <span class="va">None</span>] <span class="op">+</span> (preds <span class="op">-</span> <span class="bu">max</span>[..., <span class="va">None</span>]).exp().<span class="bu">sum</span>(<span class="op">-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>).log())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-164" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb158" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> logsumexp(x):</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">max</span> <span class="op">=</span> x.<span class="bu">max</span>(<span class="op">-</span><span class="dv">1</span>)[<span class="dv">0</span>]</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">max</span>[..., <span class="va">None</span>] <span class="op">+</span> (preds <span class="op">-</span> <span class="bu">max</span>[..., <span class="va">None</span>]).exp().<span class="bu">sum</span>(<span class="op">-</span><span class="dv">1</span>, keepdim<span class="op">=</span><span class="va">True</span>).log()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-165" class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb159" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>logsumexp(preds).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre data-code-line-numbers=""><code>torch.Size([1000, 1])</code></pre>
</div>
</div>
<div id="cell-166" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb161" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>test_close(logsumexp(preds), preds.logsumexp(<span class="op">-</span><span class="dv">1</span>)[..., <span class="va">None</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s compare how quicker our new implemenation is compared to the previous one.</p>
<div id="cell-168" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb162" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit log_softmax(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>337 µs ± 75.8 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)</code></pre>
</div>
</div>
<div id="cell-169" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb164" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_softmax(x): <span class="cf">return</span> x <span class="op">-</span> logsumexp(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-170" class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb165" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>log_softmax(preds).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre data-code-line-numbers=""><code>torch.Size([1000, 10])</code></pre>
</div>
</div>
<div id="cell-171" class="cell" data-execution_count="114">
<div class="sourceCode cell-code" id="cb167" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit log_softmax(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>190 µs ± 56 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</code></pre>
</div>
</div>
<p><em>Much</em> faster!</p>
<p>All that is left now is to multiply our softmax predictions with the one hot encoded targets, and sum the resulting vector. However, due to the nature of our targets, we can employ a nifty trick that removes the need to create a tensor of one hot encoded targets: integer array indexing.</p>
<section id="integer-array-indexing" class="level3">
<h3 class="anchored" data-anchor-id="integer-array-indexing">Integer Array Indexing</h3>
<div id="cell-175" class="cell" data-execution_count="115">
<div class="sourceCode cell-code" id="cb169" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> tensor([[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>], [<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">6</span>], [<span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">9</span>]])<span class="op">;</span> t</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre data-code-line-numbers=""><code>tensor([[1, 2, 3],
        [4, 5, 6],
        [7, 8, 9]])</code></pre>
</div>
</div>
<p>A fancy name for a simple concept, integer array indexing allows one to access elements in a tensor by simply specifing lists of indices.</p>
<div id="cell-177" class="cell" data-execution_count="116">
<div class="sourceCode cell-code" id="cb171" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>t[[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre data-code-line-numbers=""><code>tensor([1, 5, 9])</code></pre>
</div>
</div>
<p>It is best to think of the tensor as a grid of coordinates, with the first coordinate representing the row, and the second coordinate representing the column. Elements 1, 5, and 9 are at (0, 0), (1, 1), and (2, 2).</p>
<p>1, 6, and 8 are at (0, 0), (1, 2), and (2, 1)</p>
<div id="cell-179" class="cell" data-execution_count="117">
<div class="sourceCode cell-code" id="cb173" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>t[[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="117">
<pre data-code-line-numbers=""><code>tensor([1, 6, 8])</code></pre>
</div>
</div>
<p>3 and 8 are at (0, 2) and (2, 1).</p>
<div id="cell-181" class="cell" data-execution_count="118">
<div class="sourceCode cell-code" id="cb175" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>t[[<span class="dv">0</span>, <span class="dv">2</span>], [<span class="dv">2</span>, <span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="118">
<pre data-code-line-numbers=""><code>tensor([3, 8])</code></pre>
</div>
</div>
<p>Our targets consist of the integers from 0 to 9. Each row, or sample, in our predictions tensor represents a set of probabilites for each target.</p>
<p>This means we can directly access the prediction for the correct target through integer array indexing.</p>
<div id="cell-183" class="cell" data-execution_count="119">
<div class="sourceCode cell-code" id="cb177" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>trn_y[:<span class="dv">3</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="119">
<pre data-code-line-numbers=""><code>tensor([5, 0, 4])</code></pre>
</div>
</div>
<p>The targets for the first three samples are 5, 0, and, 4. Instead of manually specifying the targets when obtaining the predictions for the first three samples…</p>
<div id="cell-185" class="cell" data-execution_count="120">
<div class="sourceCode cell-code" id="cb179" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>sm_preds <span class="op">=</span> log_softmax(preds)<span class="op">;</span> sm_preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="120">
<pre data-code-line-numbers=""><code>torch.Size([1000, 10])</code></pre>
</div>
</div>
<div id="cell-186" class="cell" data-execution_count="121">
<div class="sourceCode cell-code" id="cb181" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a>sm_preds[<span class="dv">0</span>, <span class="dv">5</span>], sm_preds[<span class="dv">1</span>, <span class="dv">0</span>], sm_preds[<span class="dv">2</span>, <span class="dv">4</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="121">
<pre data-code-line-numbers=""><code>(tensor(-2.27, grad_fn=&lt;SelectBackward0&gt;),
 tensor(-2.37, grad_fn=&lt;SelectBackward0&gt;),
 tensor(-2.26, grad_fn=&lt;SelectBackward0&gt;))</code></pre>
</div>
</div>
<p>…we can use the targets themselves to directly obtain our predictions.</p>
<div id="cell-188" class="cell" data-execution_count="122">
<div class="sourceCode cell-code" id="cb183" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a>sm_preds[[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>], trn_y[:<span class="dv">3</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="122">
<pre data-code-line-numbers=""><code>tensor([-2.27, -2.37, -2.26], grad_fn=&lt;IndexBackward0&gt;)</code></pre>
</div>
</div>
<p>And now, our implementation can be completed.</p>
<div id="cell-190" class="cell" data-execution_count="123">
<div class="sourceCode cell-code" id="cb185" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> nll(preds, targs): <span class="cf">return</span> <span class="op">-</span>preds[<span class="bu">range</span>(targs.shape[<span class="dv">0</span>]), targs].mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-191" class="cell" data-execution_count="124">
<div class="sourceCode cell-code" id="cb186" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>loss <span class="op">=</span> nll(sm_preds, trn_y)<span class="op">;</span> loss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="124">
<pre data-code-line-numbers=""><code>tensor(2.30, grad_fn=&lt;NegBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-192" class="cell" data-execution_count="125">
<div class="sourceCode cell-code" id="annotated-cell-124" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><a class="code-annotation-anchor" data-target-cell="annotated-cell-124" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-124-1" class="code-annotation-target"><a href="#annotated-cell-124-1" aria-hidden="true" tabindex="-1"></a>test_close(F.nll_loss(F.log_softmax(preds, <span class="op">-</span><span class="dv">1</span>), trn_y), loss, <span class="fl">1e-3</span>)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-124" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-124" data-code-lines="1" data-code-annotation="1">The difference between <code>F.cross_entropy</code> and <code>F.nll_loss</code> is that the former expects the input to be the raw model outputs, where as the latter expects the input to already be logarithmic probabilities. It can be said that <code>F.nll_loss</code> computes cross entropy loss by starting at an intemediary step.</span>
</dd>
</dl>
</div>
</div>
</section>
</section>
<section id="basic-training-loop" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="basic-training-loop">Basic Training Loop</h2>
<p>Okay, now we have all the components of a machine that is the neural network:</p>
<ul>
<li>the linear function,</li>
<li>the activation function,</li>
<li>the loss function,</li>
<li>and the backward pass.</li>
</ul>
<p>It is time to get the machine up and running as a whole. It’s time to get the training loop looping.</p>
<div class="grid">
<div class="g-col-4">

</div>
<div class="g-col-4">
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph TB
  A[Load Data] --&gt; B[Make Predictions] --&gt; C[Compute Loss] --&gt; D[Compute Gradients] --&gt; E[Update Weights] --&gt; F[Compute Metric] --&gt; A
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</div>
<div class="g-col-4">

</div>
</div>
<div id="cell-196" class="cell" data-execution_count="126">
<div class="sourceCode cell-code" id="cb188" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a>loss_func <span class="op">=</span> F.cross_entropy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-197" class="cell" data-execution_count="127">
<div class="sourceCode cell-code" id="cb189" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>bs <span class="op">=</span> <span class="dv">50</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>xb <span class="op">=</span> trn_x[<span class="dv">0</span>:bs]</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> model(xb)<span class="op">;</span> preds[<span class="dv">0</span>], preds.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre data-code-line-numbers=""><code>(tensor([-0.08, -0.01,  0.08,  0.11, -0.02,  0.06,  0.13, -0.00, -0.08, -0.01], grad_fn=&lt;SelectBackward0&gt;),
 torch.Size([50, 10]))</code></pre>
</div>
</div>
<div id="cell-198" class="cell" data-execution_count="128">
<div class="sourceCode cell-code" id="cb191" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>yb <span class="op">=</span> trn_y[:bs]<span class="op">;</span> yb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre data-code-line-numbers=""><code>tensor([5, 0, 4, 1, 9, 2, 1, 3, 1, 4, 3, 5, 3, 6, 1, 7, 2, 8, 6, 9, 4, 0, 9, 1, 1, 2, 4, 3, 2, 7, 3, 8, 6, 9, 0, 5, 6, 0, 7, 6, 1, 8, 7, 9,
        3, 9, 8, 5, 9, 3])</code></pre>
</div>
</div>
<div id="cell-199" class="cell" data-execution_count="129">
<div class="sourceCode cell-code" id="cb193" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>loss_func(preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="129">
<pre data-code-line-numbers=""><code>tensor(2.30, grad_fn=&lt;NllLossBackward0&gt;)</code></pre>
</div>
</div>
<p>We’ll use <a href="../../dictionary/terms/accuracy.html">accuracy</a> as our metric.</p>
<div id="cell-201" class="cell" data-execution_count="130">
<div class="sourceCode cell-code" id="cb195" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>preds.argmax(<span class="op">-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="130">
<pre data-code-line-numbers=""><code>tensor([6, 2, 2, 2, 5, 2, 5, 2, 5, 2, 2, 2, 3, 2, 5, 5, 2, 2, 2, 5, 6, 3, 5, 2, 5, 2, 2, 3, 3, 2, 2, 2, 5, 2, 2, 2, 2, 2, 2, 2, 5, 2, 5, 5,
        2, 2, 2, 2, 5, 5])</code></pre>
</div>
</div>
<div id="cell-202" class="cell" data-execution_count="131">
<div class="sourceCode cell-code" id="cb197" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>(preds.argmax(<span class="op">-</span><span class="dv">1</span>) <span class="op">==</span> yb).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="131">
<pre data-code-line-numbers=""><code>tensor(5)</code></pre>
</div>
</div>
<div id="cell-203" class="cell" data-execution_count="132">
<div class="sourceCode cell-code" id="cb199" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> accuracy(preds, yb): <span class="cf">return</span> ((preds.argmax(<span class="op">-</span><span class="dv">1</span>) <span class="op">==</span> yb).<span class="bu">sum</span>()) <span class="op">/</span> yb.shape[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-204" class="cell" data-execution_count="133">
<div class="sourceCode cell-code" id="cb200" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a>accuracy(preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="133">
<pre data-code-line-numbers=""><code>tensor(0.10)</code></pre>
</div>
</div>
<div id="cell-205" class="cell" data-execution_count="134">
<div class="sourceCode cell-code" id="cb202" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>test_close(accuracy(preds, yb), (preds.argmax(<span class="op">-</span><span class="dv">1</span>) <span class="op">==</span> yb).<span class="bu">float</span>().mean())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-206" class="cell" data-execution_count="135">
<div class="sourceCode cell-code" id="cb203" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> report(loss, preds, yb): <span class="bu">print</span>(<span class="ss">f'Loss: </span><span class="sc">{</span>loss<span class="sc">:.2f}</span><span class="ss">; Accuracy: </span><span class="sc">{</span>accuracy(preds, yb)<span class="sc">:.2f}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-207" class="cell" data-execution_count="136">
<div class="sourceCode cell-code" id="cb204" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>lr, epochs <span class="op">=</span> <span class="fl">.5</span>, <span class="dv">3</span></span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> trn_x[:bs], trn_y[:bs]</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> model(xb)</span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>report(loss_func(preds, yb), preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 2.30; Accuracy: 0.10</code></pre>
</div>
</div>
<p>The training loop can now be assembled.</p>
<div id="cell-209" class="cell" data-execution_count="137">
<div class="sourceCode cell-code" id="cb206" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">slice</span>(i, <span class="bu">min</span>(n, bs<span class="op">+</span>i))</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>    xb, yb <span class="op">=</span> trn_x[s], trn_y[s]</span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model(xb)</span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> l <span class="kw">in</span> model.layers:</span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(l, <span class="st">'weight'</span>):</span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>          l.weight <span class="op">-=</span> l.weight.grad <span class="op">*</span> lr</span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>          l.bias   <span class="op">-=</span> l.bias.grad <span class="op">*</span> lr</span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>          l.weight.grad.zero_()</span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a>          l.bias  .grad.zero_()</span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>  report(loss, preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 1.01; Accuracy: 0.66
Loss: 0.45; Accuracy: 0.88
Loss: 0.37; Accuracy: 0.82</code></pre>
</div>
</div>
<p>Let’s take a closer look at how we slice: <code>s = slice(i, min(n, bs+i))</code>. We have to use <code>min</code> to prevent the slices from going out of bounds.</p>

<div class="no-row-height column-margin column-container"><div id="cell-211" class="cell" data-execution_count="138">
<div class="sourceCode cell-code" id="cb208" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a>?<span class="bu">slice</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span> slice<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">/</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">Docstring:</span>     

slice(stop)

slice(start, stop[, step])



Create a slice object.  This is used for extended slicing (e.g. a[0:10:2]).

<span class="ansi-red-fg">Type:</span>           type

<span class="ansi-red-fg">Subclasses:</span>     </pre>
</div>
</div>
</div></div><div id="cell-212" class="cell" data-execution_count="139">
<div class="sourceCode cell-code" id="cb209" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs): <span class="bu">print</span>(<span class="bu">slice</span>(i, <span class="bu">min</span>(n, bs<span class="op">+</span>i)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>slice(0, 50, None)
slice(50, 100, None)
slice(100, 150, None)
slice(150, 200, None)
slice(200, 250, None)
slice(250, 300, None)
slice(300, 350, None)
slice(350, 400, None)
slice(400, 450, None)
slice(450, 500, None)
slice(500, 550, None)
slice(550, 600, None)
slice(600, 650, None)
slice(650, 700, None)
slice(700, 750, None)
slice(750, 800, None)
slice(800, 850, None)
slice(850, 900, None)
slice(900, 950, None)
slice(950, 1000, None)</code></pre>
</div>
</div>
<p>Simply adding <code>bs</code> to <code>n</code> at the <code>end</code> parameter for <code>range</code> will not work.</p>
<div id="cell-214" class="cell" data-execution_count="140">
<div class="sourceCode cell-code" id="cb211" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n<span class="op">+</span>bs, bs): <span class="bu">print</span>(<span class="bu">slice</span>(i, bs<span class="op">+</span>i))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>slice(0, 50, None)
slice(50, 100, None)
slice(100, 150, None)
slice(150, 200, None)
slice(200, 250, None)
slice(250, 300, None)
slice(300, 350, None)
slice(350, 400, None)
slice(400, 450, None)
slice(450, 500, None)
slice(500, 550, None)
slice(550, 600, None)
slice(600, 650, None)
slice(650, 700, None)
slice(700, 750, None)
slice(750, 800, None)
slice(800, 850, None)
slice(850, 900, None)
slice(900, 950, None)
slice(950, 1000, None)
slice(1000, 1050, None)</code></pre>
</div>
</div>
</section>
<section id="parameters-optimizers" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="parameters-optimizers">Parameters &amp; Optimizers</h2>
<p>Currently, we update our weights by checking whether a layer in our network has a <code>weight</code> attribute.</p>
<div class="sourceCode" id="cb213" data-code-line-numbers="8,9,10,11,12,13,14"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>    s <span class="op">=</span> <span class="bu">slice</span>(i, <span class="bu">min</span>(n, bs<span class="op">+</span>i))</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>    xb, yb <span class="op">=</span> trn_x[s], trn_y[s]</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model(xb)</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad(): </span>
<span id="cb213-9"><a href="#cb213-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> l <span class="kw">in</span> model.layers: </span>
<span id="cb213-10"><a href="#cb213-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">hasattr</span>(l, <span class="st">'weight'</span>): </span>
<span id="cb213-11"><a href="#cb213-11" aria-hidden="true" tabindex="-1"></a>          l.weight <span class="op">-=</span> l.weight.grad <span class="op">*</span> lr </span>
<span id="cb213-12"><a href="#cb213-12" aria-hidden="true" tabindex="-1"></a>          l.bias   <span class="op">-=</span> l.bias.grad <span class="op">*</span> lr </span>
<span id="cb213-13"><a href="#cb213-13" aria-hidden="true" tabindex="-1"></a>          l.weight.grad.zero_() </span>
<span id="cb213-14"><a href="#cb213-14" aria-hidden="true" tabindex="-1"></a>          l.bias  .grad.zero_() </span>
<span id="cb213-15"><a href="#cb213-15" aria-hidden="true" tabindex="-1"></a>  report(loss, preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>PyTorch actually keeps track which layers have weights. Let us explore.</p>
<p>Here, PyTorch knows that our model has a linear layer with 3 inputs and 4 outputs.</p>
<div id="cell-218" class="cell" data-execution_count="141">
<div class="sourceCode cell-code" id="cb214" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="op">=</span> nn.Module()</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>m1.foo <span class="op">=</span> nn.Linear(<span class="dv">3</span>, <span class="dv">4</span>)<span class="op">;</span> m1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="141">
<pre data-code-line-numbers=""><code>Module(
  (foo): Linear(in_features=3, out_features=4, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-219" class="cell" data-execution_count="142">
<div class="sourceCode cell-code" id="cb216" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(m1.named_children())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="142">
<pre data-code-line-numbers=""><code>[('foo', Linear(in_features=3, out_features=4, bias=True))]</code></pre>
</div>
</div>
<p>In a similar manner, we can access the layer’s parameters.</p>
<div id="cell-223" class="cell" data-execution_count="145">
<div class="sourceCode cell-code" id="cb218" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(m1.foo.parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="145">
<pre data-code-line-numbers=""><code>[Parameter containing:
 tensor([[-0.37,  0.20, -0.39],
         [-0.47,  0.00,  0.18],
         [ 0.51, -0.35,  0.36],
         [ 0.12,  0.10, -0.03]], requires_grad=True),
 Parameter containing:
 tensor([ 0.31, -0.42,  0.35,  0.16], requires_grad=True)]</code></pre>
</div>
</div>
<p>However, this approach will require us to loop through all layers to access all parameters. PyTorch instead provides a way to directly return the parameters of all layers.</p>
<div id="cell-225" class="cell" data-execution_count="146">
<div class="sourceCode cell-code" id="cb220" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(m1.parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="146">
<pre data-code-line-numbers=""><code>[Parameter containing:
 tensor([[-0.37,  0.20, -0.39],
         [-0.47,  0.00,  0.18],
         [ 0.51, -0.35,  0.36],
         [ 0.12,  0.10, -0.03]], requires_grad=True),
 Parameter containing:
 tensor([ 0.31, -0.42,  0.35,  0.16], requires_grad=True)]</code></pre>
</div>
</div>
<div id="cell-226" class="cell" data-execution_count="147">
<div class="sourceCode cell-code" id="cb222" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MLP(nn.Module):</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inps, nh, n_outs):</span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.l1 <span class="op">=</span> nn.Linear(n_inps, nh)</span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.l2 <span class="op">=</span> nn.Linear(nh, n_outs)</span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.relu <span class="op">=</span> nn.ReLU()</span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x): <span class="cf">return</span> <span class="va">self</span>.l2(<span class="va">self</span>.relu(<span class="va">self</span>.l1(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-227" class="cell" data-execution_count="148">
<div class="sourceCode cell-code" id="cb223" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>n, m, nh, c</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="148">
<pre data-code-line-numbers=""><code>(1000, 784, 50, tensor(10))</code></pre>
</div>
</div>
<div id="cell-228" class="cell" data-execution_count="149">
<div class="sourceCode cell-code" id="cb225" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MLP(m, nh, c)<span class="op">;</span> model.l1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="149">
<pre data-code-line-numbers=""><code>Linear(in_features=784, out_features=50, bias=True)</code></pre>
</div>
</div>
<div id="cell-229" class="cell" data-execution_count="150">
<div class="sourceCode cell-code" id="cb227" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a>model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="150">
<pre data-code-line-numbers=""><code>MLP(
  (l1): Linear(in_features=784, out_features=50, bias=True)
  (l2): Linear(in_features=50, out_features=10, bias=True)
  (relu): ReLU()
)</code></pre>
</div>
</div>
<div id="cell-230" class="cell" data-execution_count="151">
<div class="sourceCode cell-code" id="cb229" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, l <span class="kw">in</span> model.named_children(): <span class="bu">print</span>(<span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>l<span class="sc">}</span><span class="ss">'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>l1: Linear(in_features=784, out_features=50, bias=True)
l2: Linear(in_features=50, out_features=10, bias=True)
relu: ReLU()</code></pre>
</div>
</div>
<div id="cell-231" class="cell" data-execution_count="152">
<div class="sourceCode cell-code" id="cb231" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> model.parameters(): <span class="bu">print</span>(p.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>torch.Size([50, 784])
torch.Size([50])
torch.Size([10, 50])
torch.Size([10])</code></pre>
</div>
</div>
<p>Since we can directly access the parameters, we do not need to check whether a certain parameter exists.</p>
<div id="cell-234" class="cell" data-source-line-numbers="9-12" data-execution_count="154">
<div class="sourceCode cell-code" id="annotated-cell-151" data-source-line-numbers="9-12" data-code-line-numbers="9-12"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-151-1"><a href="#annotated-cell-151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit():</span>
<span id="annotated-cell-151-2"><a href="#annotated-cell-151-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="annotated-cell-151-3"><a href="#annotated-cell-151-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="annotated-cell-151-4"><a href="#annotated-cell-151-4" aria-hidden="true" tabindex="-1"></a>      s <span class="op">=</span> <span class="bu">slice</span>(i, <span class="bu">min</span>(n, bs<span class="op">+</span>i))</span>
<span id="annotated-cell-151-5"><a href="#annotated-cell-151-5" aria-hidden="true" tabindex="-1"></a>      xb, yb <span class="op">=</span> trn_x[s], trn_y[s]</span>
<span id="annotated-cell-151-6"><a href="#annotated-cell-151-6" aria-hidden="true" tabindex="-1"></a>      preds <span class="op">=</span> model(xb)</span>
<span id="annotated-cell-151-7"><a href="#annotated-cell-151-7" aria-hidden="true" tabindex="-1"></a>      loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="annotated-cell-151-8"><a href="#annotated-cell-151-8" aria-hidden="true" tabindex="-1"></a>      loss.backward()</span>
<span id="annotated-cell-151-9"><a href="#annotated-cell-151-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">with</span> torch.no_grad():</span>
<span id="annotated-cell-151-10"><a href="#annotated-cell-151-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> model.parameters(): p <span class="op">-=</span> p.grad <span class="op">*</span> lr</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-151" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-151-11" class="code-annotation-target"><a href="#annotated-cell-151-11" aria-hidden="true" tabindex="-1"></a>        model.zero_grad()</span>
<span id="annotated-cell-151-12"><a href="#annotated-cell-151-12" aria-hidden="true" tabindex="-1"></a>    report(loss, preds, yb)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-151" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-151" data-code-lines="11" data-code-annotation="1"><code>torch.zero_grad()</code> can also be called directly on the model itself.</span>
</dd>
</dl>
</div>
</div>
<div id="cell-236" class="cell" data-execution_count="155">
<div class="sourceCode cell-code" id="cb233" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" aria-hidden="true" tabindex="-1"></a>fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 0.84; Accuracy: 0.74
Loss: 0.45; Accuracy: 0.88
Loss: 0.37; Accuracy: 0.84</code></pre>
</div>
</div>
<p>Let us implement this functionality–where the model itself knows what its layers and parameters are–ourselves.</p>
<p>To do so, we will need to define the <code>__setattr__</code> dunder method, where any submodules defined are registered as parameters of the model.</p>
<div id="cell-238" class="cell" data-execution_count="156">
<div class="sourceCode cell-code" id="annotated-cell-153" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-153-1"><a href="#annotated-cell-153-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyModule:</span>
<span id="annotated-cell-153-2"><a href="#annotated-cell-153-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, n_inps, nh, n_outs):</span>
<span id="annotated-cell-153-3"><a href="#annotated-cell-153-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>._modules <span class="op">=</span> {}</span>
<span id="annotated-cell-153-4"><a href="#annotated-cell-153-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.l1 <span class="op">=</span> nn.Linear(n_inps, nh)</span>
<span id="annotated-cell-153-5"><a href="#annotated-cell-153-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.l2 <span class="op">=</span> nn.Linear(nh, n_outs)</span>
<span id="annotated-cell-153-6"><a href="#annotated-cell-153-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-153-7"><a href="#annotated-cell-153-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__setattr__</span>(<span class="va">self</span>, k, v):</span>
<span id="annotated-cell-153-8"><a href="#annotated-cell-153-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> k.startswith(<span class="st">'_'</span>): <span class="va">self</span>._modules[k] <span class="op">=</span> v</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-153" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-153-9" class="code-annotation-target"><a href="#annotated-cell-153-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__setattr__</span>(k, v)</span>
<span id="annotated-cell-153-10"><a href="#annotated-cell-153-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="annotated-cell-153-11"><a href="#annotated-cell-153-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>): <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>_modules<span class="sc">}</span><span class="ss">'</span></span>
<span id="annotated-cell-153-12"><a href="#annotated-cell-153-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-153-13"><a href="#annotated-cell-153-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> parameters(<span class="va">self</span>):</span>
<span id="annotated-cell-153-14"><a href="#annotated-cell-153-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> l <span class="kw">in</span> <span class="va">self</span>._modules.values(): <span class="cf">yield</span> <span class="cf">from</span> l.parameters()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-153" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-153" data-code-lines="9" data-code-annotation="1"><code>class MyModule</code> is actually <code>class MyModule(object)</code></span>
</dd>
</dl>
</div>
</div>
<div id="cell-240" class="cell" data-execution_count="157">
<div class="sourceCode cell-code" id="cb235" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>mdl <span class="op">=</span> MyModule(m, nh, c)<span class="op">;</span> mdl, model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="157">
<pre data-code-line-numbers=""><code>({'l1': Linear(in_features=784, out_features=50, bias=True), 'l2': Linear(in_features=50, out_features=10, bias=True)},
 MLP(
   (l1): Linear(in_features=784, out_features=50, bias=True)
   (l2): Linear(in_features=50, out_features=10, bias=True)
   (relu): ReLU()
 ))</code></pre>
</div>
</div>
<div id="cell-241" class="cell" data-execution_count="158">
<div class="sourceCode cell-code" id="cb237" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> p <span class="kw">in</span> mdl.parameters(): <span class="bu">print</span>(p.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>torch.Size([50, 784])
torch.Size([50])
torch.Size([10, 50])
torch.Size([10])</code></pre>
</div>
</div>
<section id="registering-modules" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="registering-modules">Registering Modules</h3>
<p>To use our original approach, where a list of layers are specified, we can use the <code>add_module</code> method provided by PyTorch.</p>
<div id="cell-244" class="cell" data-execution_count="159">
<div class="sourceCode cell-code" id="cb239" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>?nn.Module.add_module</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span>

nn<span class="ansi-blue-fg">.</span>Module<span class="ansi-blue-fg">.</span>add_module<span class="ansi-blue-fg">(</span>

    self<span class="ansi-blue-fg">,</span>

    name<span class="ansi-blue-fg">:</span> str<span class="ansi-blue-fg">,</span>

    module<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>ForwardRef<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">'Module'</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>

<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> <span class="ansi-green-fg">None</span>

<span class="ansi-red-fg">Docstring:</span>

Adds a child module to the current module.



The module can be accessed as an attribute using the given name.



Args:

    name (str): name of the child module. The child module can be

        accessed from this module using the given name

    module (Module): child module to be added to the module.

<span class="ansi-red-fg">File:</span>      ~/mambaforge/envs/default/lib/python3.10/site-packages/torch/nn/modules/module.py

<span class="ansi-red-fg">Type:</span>      function</pre>
</div>
</div>
</div>
<div id="cell-245" class="cell" data-execution_count="160">
<div class="sourceCode cell-code" id="cb240" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a>layers <span class="op">=</span> [nn.Linear(m, nh), nn.ReLU(), nn.Linear(nh, c)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-246" class="cell" data-execution_count="161">
<div class="sourceCode cell-code" id="annotated-cell-158" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-158-1"><a href="#annotated-cell-158-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> <span class="bu">reduce</span></span>
<span id="annotated-cell-158-2"><a href="#annotated-cell-158-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Model(nn.Module):</span>
<span id="annotated-cell-158-3"><a href="#annotated-cell-158-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, layers):</span>
<span id="annotated-cell-158-4"><a href="#annotated-cell-158-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="annotated-cell-158-5"><a href="#annotated-cell-158-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.layers <span class="op">=</span> layers</span>
<span id="annotated-cell-158-6"><a href="#annotated-cell-158-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, l <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.layers): <span class="va">self</span>.add_module(<span class="ss">f'layer_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, l)</span>
<span id="annotated-cell-158-7"><a href="#annotated-cell-158-7" aria-hidden="true" tabindex="-1"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-158" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-158-8" class="code-annotation-target"><a href="#annotated-cell-158-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x): <span class="cf">return</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> val, layer: layer(val), <span class="va">self</span>.layers, x)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-158" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-158" data-code-lines="8" data-code-annotation="1">In essence, <code>reduce</code> uses the output of the function as input to the same function in the next iteration.</span>
</dd>
</dl>
</div>
</div>

<div class="no-row-height column-margin column-container"><div id="cell-248" class="cell" data-execution_count="162">
<div class="sourceCode cell-code" id="cb241" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>?<span class="bu">reduce</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Docstring:</span>

reduce(function, iterable[, initial]) -&gt; value



Apply a function of two arguments cumulatively to the items of a sequence

or iterable, from left to right, so as to reduce the iterable to a single

value.  For example, reduce(lambda x, y: x+y, [1, 2, 3, 4, 5]) calculates

((((1+2)+3)+4)+5).  If initial is present, it is placed before the items

of the iterable in the calculation, and serves as a default when the

iterable is empty.

<span class="ansi-red-fg">Type:</span>      builtin_function_or_method</pre>
</div>
</div>
</div></div><div id="cell-249" class="cell" data-execution_count="163">
<div class="sourceCode cell-code" id="cb242" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a><span class="bu">reduce</span>(<span class="kw">lambda</span> x,y: x<span class="op">+</span>y, [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="163">
<pre data-code-line-numbers=""><code>15</code></pre>
</div>
</div>
<div id="cell-250" class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb244" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Model(layers)<span class="op">;</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="164">
<pre data-code-line-numbers=""><code>Model(
  (layer_0): Linear(in_features=784, out_features=50, bias=True)
  (layer_1): ReLU()
  (layer_2): Linear(in_features=50, out_features=10, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-251" class="cell" data-execution_count="165">
<div class="sourceCode cell-code" id="cb246" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>model(xb).shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="165">
<pre data-code-line-numbers=""><code>torch.Size([50, 10])</code></pre>
</div>
</div>
<p>Alternatively, <code>nn.ModuleList</code> can do the registration for us.</p>

<div class="no-row-height column-margin column-container"><div id="cell-253" class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb248" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>?nn.ModuleList</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>

nn<span class="ansi-blue-fg">.</span>ModuleList<span class="ansi-blue-fg">(</span>

    modules<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>Iterable<span class="ansi-blue-fg">[</span>torch<span class="ansi-blue-fg">.</span>nn<span class="ansi-blue-fg">.</span>modules<span class="ansi-blue-fg">.</span>module<span class="ansi-blue-fg">.</span>Module<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> <span class="ansi-green-fg">None</span>

<span class="ansi-red-fg">Docstring:</span>     

Holds submodules in a list.



:class:`~torch.nn.ModuleList` can be indexed like a regular Python list, but

modules it contains are properly registered, and will be visible by all

:class:`~torch.nn.Module` methods.



Args:

    modules (iterable, optional): an iterable of modules to add



Example::



    class MyModule(nn.Module):

        def __init__(self):

            super().__init__()

            self.linears = nn.ModuleList([nn.Linear(10, 10) for i in range(10)])



        def forward(self, x):

            # ModuleList can act as an iterable, or be indexed using ints

            for i, l in enumerate(self.linears):

                x = self.linears[i // 2](x) + l(x)

            return x

<span class="ansi-red-fg">Init docstring:</span> Initializes internal Module state, shared by both nn.Module and ScriptModule.

<span class="ansi-red-fg">File:</span>           ~/mambaforge/envs/default/lib/python3.10/site-packages/torch/nn/modules/container.py

<span class="ansi-red-fg">Type:</span>           type

<span class="ansi-red-fg">Subclasses:</span>     ParametrizationList</pre>
</div>
</div>
</div></div><div id="cell-254" class="cell" data-execution_count="167">
<div class="sourceCode cell-code" id="cb249" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SequentialModel(nn.Module):</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, layers):</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.layers <span class="op">=</span> nn.ModuleList(layers)</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> forward(<span class="va">self</span>, x): <span class="cf">return</span> <span class="bu">reduce</span>(<span class="kw">lambda</span> x, layer: layer(x), <span class="va">self</span>.layers, x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-255" class="cell" data-execution_count="168">
<div class="sourceCode cell-code" id="cb250" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SequentialModel(layers)<span class="op">;</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="168">
<pre data-code-line-numbers=""><code>SequentialModel(
  (layers): ModuleList(
    (0): Linear(in_features=784, out_features=50, bias=True)
    (1): ReLU()
    (2): Linear(in_features=50, out_features=10, bias=True)
  )
)</code></pre>
</div>
</div>
<div id="cell-256" class="cell" data-execution_count="169">
<div class="sourceCode cell-code" id="cb252" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 0.93; Accuracy: 0.78
Loss: 0.52; Accuracy: 0.86
Loss: 0.38; Accuracy: 0.86</code></pre>
</div>
</div>
<div id="cell-257" class="cell" data-execution_count="170">
<div class="sourceCode cell-code" id="cb254" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> nn.Sequential(nn.Linear(m, nh), nn.ReLU(), nn.Linear(nh, c))<span class="op">;</span> model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="170">
<pre data-code-line-numbers=""><code>Sequential(
  (0): Linear(in_features=784, out_features=50, bias=True)
  (1): ReLU()
  (2): Linear(in_features=50, out_features=10, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-258" class="cell" data-execution_count="171">
<div class="sourceCode cell-code" id="cb256" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 0.88; Accuracy: 0.74
Loss: 0.48; Accuracy: 0.86
Loss: 0.39; Accuracy: 0.88</code></pre>
</div>
</div>
</section>
<section id="optimizer" class="level3">
<h3 class="anchored" data-anchor-id="optimizer">Optimizer</h3>
<p>Optimizer is simply the name given to the algorithm that updates the weights.</p>
<div id="cell-261" class="cell" data-execution_count="172">
<div class="sourceCode cell-code" id="cb258" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Optimizer:</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, params, lr<span class="op">=</span><span class="fl">0.5</span>): <span class="va">self</span>.params,<span class="va">self</span>.lr <span class="op">=</span> <span class="bu">list</span>(params), lr</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> step(<span class="va">self</span>):</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.params: p <span class="op">-=</span> p.grad <span class="op">*</span> <span class="va">self</span>.lr</span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> zero_grad(<span class="va">self</span>):</span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> <span class="va">self</span>.params: p.grad.data.zero_()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-262" class="cell" data-execution_count="173">
<div class="sourceCode cell-code" id="cb259" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> nn.Sequential(nn.Linear(m, nh), nn.ReLU(), nn.Linear(nh, c))</span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>opt <span class="op">=</span> Optimizer(model.parameters())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The weight update step can now be cleaned up by using <code>opt.step()</code> and <code>opt.zero_grad()</code> instead.</p>
<div class="sourceCode" id="cb260" data-code-line-numbers="9,10,11"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit():</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>      s <span class="op">=</span> <span class="bu">slice</span>(i, <span class="bu">min</span>(n, i<span class="op">+</span>bs))</span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>      xb, yb <span class="op">=</span> trn_x[s], trn_y[s]</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>      preds <span class="op">=</span> model(xb)</span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>      loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>      loss.backward()</span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">with</span> torch.no_grad(): </span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> model.parameters(): p <span class="op">-=</span> p.grad <span class="op">*</span> lr </span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a>        model.zero_grad() </span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>    report(loss, preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="cell-264" class="cell" data-execution_count="174">
<div class="sourceCode cell-code" id="cb261" data-source-line-numbers="nil" data-code-line-numbers="9,10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit():</span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>      s <span class="op">=</span> <span class="bu">slice</span>(i, <span class="bu">min</span>(n, i<span class="op">+</span>bs))</span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>      xb, yb <span class="op">=</span> trn_x[s], trn_y[s]</span>
<span id="cb261-6"><a href="#cb261-6" aria-hidden="true" tabindex="-1"></a>      preds <span class="op">=</span> model(xb)</span>
<span id="cb261-7"><a href="#cb261-7" aria-hidden="true" tabindex="-1"></a>      loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="cb261-8"><a href="#cb261-8" aria-hidden="true" tabindex="-1"></a>      loss.backward()</span>
<span id="cb261-9"><a href="#cb261-9" aria-hidden="true" tabindex="-1"></a>      opt.step() </span>
<span id="cb261-10"><a href="#cb261-10" aria-hidden="true" tabindex="-1"></a>      opt.zero_grad() </span>
<span id="cb261-11"><a href="#cb261-11" aria-hidden="true" tabindex="-1"></a>    report(loss, preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-265" class="cell" data-execution_count="175">
<div class="sourceCode cell-code" id="cb262" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 0.89; Accuracy: 0.74
Loss: 0.51; Accuracy: 0.88
Loss: 0.41; Accuracy: 0.86</code></pre>
</div>
</div>
<div id="cell-266" class="cell" data-execution_count="176">
<div class="sourceCode cell-code" id="cb264" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> optim</span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_model():</span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a>  model <span class="op">=</span> nn.Sequential(nn.Linear(m, nh), nn.ReLU(), nn.Linear(nh, c))</span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> model, optim.SGD(model.parameters(), lr<span class="op">=</span>lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-267" class="cell" data-execution_count="177">
<div class="sourceCode cell-code" id="cb265" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>model, opt <span class="op">=</span> get_model()</span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a>loss_func(model(xb), yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="177">
<pre data-code-line-numbers=""><code>tensor(2.32, grad_fn=&lt;NllLossBackward0&gt;)</code></pre>
</div>
</div>
<div id="cell-268" class="cell" data-execution_count="178">
<div class="sourceCode cell-code" id="cb267" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a>fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 0.82; Accuracy: 0.78
Loss: 0.42; Accuracy: 0.90
Loss: 0.35; Accuracy: 0.86</code></pre>
</div>
</div>
</section>
</section>
<section id="dataset-and-dataloader" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="dataset-and-dataloader">Dataset and Dataloader</h2>
<p>I sometimes get confuzzled between the two terms, with regard to what each component actually does. The best way to think about these terms is that a dataset simply stores data in a massive warehouse, while a dataloader takes data from the dataset and tosses them into crates known as batches.</p>
<p>As it currently is, we iterate through our dataset by obtaining a slice object, and then slicing out some data to form a batch.</p>
<div class="sourceCode" id="cb269" data-code-line-numbers=""><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>  s <span class="op">=</span> <span class="bu">slice</span>(i, <span class="bu">min</span>(n, bs<span class="op">+</span>i))</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a>  xb, yb <span class="op">=</span> trn_x[s], trn_y[s]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will now simplify how we approach this logic.</p>
<section id="dataset" class="level3">
<h3 class="anchored" data-anchor-id="dataset">Dataset</h3>
<p>The first point of simplification is to create a single dataset that will return both a sample and its associated target, from a single index. This will prevent us from having to index into two separate tensors.</p>
<div id="cell-273" class="cell" data-execution_count="179">
<div class="sourceCode cell-code" id="cb270" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dataset():</span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, x, y): <span class="va">self</span>.x, <span class="va">self</span>.y <span class="op">=</span> x, y</span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>): <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.x)</span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, i): <span class="cf">return</span> <span class="va">self</span>.x[i], <span class="va">self</span>.y[i]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-274" class="cell" data-execution_count="180">
<div class="sourceCode cell-code" id="cb271" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>trn_ds, vld_ds <span class="op">=</span> Dataset(trn_x, trn_y), Dataset(vld_x, vld_y)</span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(trn_ds) <span class="op">==</span> <span class="bu">len</span>(trn_x)</span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> <span class="bu">len</span>(vld_ds) <span class="op">==</span> <span class="bu">len</span>(vld_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-275" class="cell" data-execution_count="181">
<div class="sourceCode cell-code" id="cb272" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> trn_ds[<span class="dv">0</span>:<span class="dv">5</span>]</span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> xb.shape <span class="op">==</span> (<span class="dv">5</span>, <span class="dv">28</span><span class="op">*</span><span class="dv">28</span>)</span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a><span class="cf">assert</span> yb.shape <span class="op">==</span> (<span class="dv">5</span>,)</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>xb, yb</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="181">
<pre data-code-line-numbers=""><code>(tensor([[0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.]]),
 tensor([5, 0, 4, 1, 9]))</code></pre>
</div>
</div>
<div id="cell-276" class="cell" data-execution_count="182">
<div class="sourceCode cell-code" id="cb274" data-source-line-numbers="nil" data-code-line-numbers="4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>model, opt <span class="op">=</span> get_model()</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb274-4"><a href="#cb274-4" aria-hidden="true" tabindex="-1"></a>    xb, yb <span class="op">=</span> trn_ds[i:<span class="bu">min</span>(n, bs<span class="op">+</span>i)] </span>
<span id="cb274-5"><a href="#cb274-5" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model(xb)</span>
<span id="cb274-6"><a href="#cb274-6" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="cb274-7"><a href="#cb274-7" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb274-8"><a href="#cb274-8" aria-hidden="true" tabindex="-1"></a>    opt.step()</span>
<span id="cb274-9"><a href="#cb274-9" aria-hidden="true" tabindex="-1"></a>    opt.zero_grad()</span>
<span id="cb274-10"><a href="#cb274-10" aria-hidden="true" tabindex="-1"></a>  report(loss, preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 1.19; Accuracy: 0.70
Loss: 0.50; Accuracy: 0.88
Loss: 0.34; Accuracy: 0.88</code></pre>
</div>
</div>
</section>
<section id="dataloader" class="level3">
<h3 class="anchored" data-anchor-id="dataloader">DataLoader</h3>
<p>Let us now abstract away how the data from our datasets is loaded, by putting the logic that fetches data from the dataset…</p>
<div class="sourceCode" id="cb276" data-code-line-numbers="2"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>  xb, yb <span class="op">=</span> trn_ds[i:<span class="bu">min</span>(n,i<span class="op">+</span>bs)] </span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>  ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>…into a class that we can call a dataloader.</p>
<div class="sourceCode" id="cb277" data-code-line-numbers="1"><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> xb, yb <span class="kw">in</span> train_dl: </span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>  ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="cell-279" class="cell" data-execution_count="183">
<div class="sourceCode cell-code" id="cb278" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataLoader():</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ds, bs): <span class="va">self</span>.ds,<span class="va">self</span>.bs <span class="op">=</span> ds,bs</span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__iter__</span>(<span class="va">self</span>):</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(<span class="va">self</span>.ds), <span class="va">self</span>.bs): <span class="cf">yield</span> <span class="va">self</span>.ds[i:<span class="bu">min</span>(<span class="bu">len</span>(<span class="va">self</span>.ds), i<span class="op">+</span><span class="va">self</span>.bs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-280" class="cell" data-execution_count="184">
<div class="sourceCode cell-code" id="cb279" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a>trn_dl, vld_dl <span class="op">=</span> DataLoader(trn_ds, bs), DataLoader(vld_ds, bs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-281" class="cell" data-execution_count="185">
<div class="sourceCode cell-code" id="cb280" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(<span class="bu">iter</span>(vld_dl))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="185">
<pre data-code-line-numbers=""><code>(tensor([[0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         ...,
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.]]),
 tensor([3, 8, 6, 9, 6, 4, 5, 3, 8, 4, 5, 2, 3, 8, 4, 8, 1, 5, 0, 5, 9, 7, 4, 1, 0, 3, 0, 6, 2, 9, 9, 4, 1, 3, 6, 8, 0, 7, 7, 6, 8, 9, 0, 3,
         8, 3, 7, 7, 8, 4]))</code></pre>
</div>
</div>
<div id="cell-282" class="cell" data-execution_count="186">
<div class="sourceCode cell-code" id="cb282" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(vld_dl))<span class="op">;</span> xb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="186">
<pre data-code-line-numbers=""><code>torch.Size([50, 784])</code></pre>
</div>
</div>
<div id="cell-283" class="cell" data-execution_count="187">
<div class="sourceCode cell-code" id="cb284" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>plt.imshow(xb[<span class="dv">0</span>].view(<span class="dv">28</span>, <span class="dv">28</span>))<span class="op">;</span> yb[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="187">
<pre data-code-line-numbers=""><code>tensor(3)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="20_models_from_scratch_files/figure-html/cell-188-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-284" class="cell" data-execution_count="188">
<div class="sourceCode cell-code" id="cb286" data-source-line-numbers="nil" data-code-line-numbers="3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit():</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> xb, yb <span class="kw">in</span> trn_dl: </span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>      preds <span class="op">=</span> model(xb)</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a>      loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a>      loss.backward()</span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a>      opt.step()</span>
<span id="cb286-8"><a href="#cb286-8" aria-hidden="true" tabindex="-1"></a>      opt.zero_grad()</span>
<span id="cb286-9"><a href="#cb286-9" aria-hidden="true" tabindex="-1"></a>    report(loss, preds, yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-285" class="cell" data-execution_count="189">
<div class="sourceCode cell-code" id="cb287" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>model, opt <span class="op">=</span> get_model()</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 0.79; Accuracy: 0.82
Loss: 0.49; Accuracy: 0.84
Loss: 0.30; Accuracy: 0.88</code></pre>
</div>
</div>
<p>And just like that, we have abstracted our loading logic from three lines…</p>
<div class="sourceCode" id="cb289" data-code-line-numbers=""><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, n, bs):</span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>  s <span class="op">=</span> <span class="bu">slice</span>(i, <span class="bu">min</span>(n, bs<span class="op">+</span>i))</span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>  xb, yb <span class="op">=</span> trn_x[s], trn_y[s]</span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a>  ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>…to a much more readable single line.</p>
<div class="sourceCode" id="cb290" data-code-line-numbers=""><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> xb, yb <span class="kw">in</span> trn_dl:</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a>  ...</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="random-sampling" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="random-sampling">Random Sampling</h3>
<p>Sampling is the method by which the dataloader selects indices from the dataset to load. Sampling from the training set should be random (due to the nature of our data), but not for the validation set.</p>
<p>Therefore, we will need to create an additional class for the our dataloader; a component that tells the dataloader from which indices to load data from the dataset.</p>
<div id="cell-289" class="cell" data-execution_count="190">
<div class="sourceCode cell-code" id="cb291" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>?random.shuffle</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> random<span class="ansi-blue-fg">.</span>shuffle<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span> random<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">Docstring:</span>

Shuffle list x in place, and return None.



Optional argument random is a 0-argument function returning a

random float in [0.0, 1.0); if it is the default None, the

standard random.random will be used.

<span class="ansi-red-fg">File:</span>      ~/mambaforge/envs/default/lib/python3.10/random.py

<span class="ansi-red-fg">Type:</span>      method</pre>
</div>
</div>
</div>
<div id="cell-290" class="cell" data-execution_count="191">
<div class="sourceCode cell-code" id="cb292" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Sampler():</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ds, shuffle<span class="op">=</span><span class="va">False</span>): <span class="va">self</span>.n,<span class="va">self</span>.shuffle <span class="op">=</span> <span class="bu">len</span>(ds),shuffle</span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__iter__</span>(<span class="va">self</span>):</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="va">self</span>.n))</span>
<span id="cb292-5"><a href="#cb292-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span>.shuffle: random.shuffle(res)</span>
<span id="cb292-6"><a href="#cb292-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">iter</span>(res)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-291" class="cell" data-execution_count="192">
<div class="sourceCode cell-code" id="cb293" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a>ss <span class="op">=</span> Sampler(trn_ds)<span class="op">;</span> ss</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="192">
<pre data-code-line-numbers=""><code>&lt;__main__.Sampler at 0x150dddd80&gt;</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div id="cell-292" class="cell" data-execution_count="193">
<div class="sourceCode cell-code" id="cb295" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="bu">print</span>(<span class="bu">next</span>(ss))</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>: <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div><div class="">
<p>This does not work because <code>__iter__</code> is not being called. <code>__iter__</code> only gets called when we wrap the class with <code>iter()</code>.</p>
</div><div id="cell-294" class="cell" data-execution_count="194">
<div class="sourceCode cell-code" id="cb296" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>: <span class="bu">print</span>(<span class="bu">next</span>(<span class="bu">iter</span>(ss)))</span>
<span id="cb296-2"><a href="#cb296-2" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>: <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>0</code></pre>
</div>
</div></div>

<div id="cell-295" class="cell" data-execution_count="195">
<div class="sourceCode cell-code" id="cb298" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a>it <span class="op">=</span> <span class="bu">iter</span>(ss)<span class="op">;</span> it</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="195">
<pre data-code-line-numbers=""><code>&lt;list_iterator at 0x150996fe0&gt;</code></pre>
</div>
</div>
<div id="cell-296" class="cell" data-execution_count="196">
<div class="sourceCode cell-code" id="cb300" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>): <span class="bu">print</span>(<span class="bu">next</span>(it))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>0
1
2
3
4</code></pre>
</div>
</div>
<p>The <code>Sampler</code> currently returns a single index in each iteration. We need to change that so a number of indices (equal to our batch size) is returned in each iteration. We can do this through a fancy slicing function known as <code>islice</code>.</p>
<div id="cell-298" class="cell" data-execution_count="197">
<div class="sourceCode cell-code" id="cb302" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> islice</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a>?islice</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span> islice<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">/</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">Docstring:</span>     

islice(iterable, stop) --&gt; islice object

islice(iterable, start, stop[, step]) --&gt; islice object



Return an iterator whose next() method returns selected values from an

iterable.  If start is specified, will skip all preceding elements;

otherwise, start defaults to zero.  Step defaults to one.  If

specified as another value, step determines how many values are

skipped between successive calls.  Works like a slice() on a list

but returns an iterator.

<span class="ansi-red-fg">Type:</span>           type

<span class="ansi-red-fg">Subclasses:</span>     </pre>
</div>
</div>
</div>
<p><code>iter</code> returns a single element from an iterable at a time. <code>islice</code> is a type of iterator that returns <span class="math inline">\(x\)</span> elements from an iterable at a time. It is an, erm, iterative slice.</p>
<div id="cell-300" class="cell" data-execution_count="198">
<div class="sourceCode cell-code" id="cb303" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(islice(ss, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="198">
<pre data-code-line-numbers=""><code>[0, 1, 2, 3, 4]</code></pre>
</div>
</div>
<p>Let’s define an additional class that takes a sampler, and assembles its output into batches.</p>
<div id="cell-302" class="cell" data-execution_count="199">
<div class="sourceCode cell-code" id="annotated-cell-202" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-annotation-code code-with-copy code-annotated"><code class="sourceCode python"><span id="annotated-cell-202-1"><a href="#annotated-cell-202-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BatchSampler:</span>
<span id="annotated-cell-202-2"><a href="#annotated-cell-202-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, sampler, bs, drop_last<span class="op">=</span><span class="va">False</span>): store_attr()</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-202" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-202-3" class="code-annotation-target"><a href="#annotated-cell-202-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__iter__</span>(<span class="va">self</span>): <span class="cf">yield</span> <span class="cf">from</span> chunked(<span class="bu">iter</span>(<span class="va">self</span>.sampler), <span class="va">self</span>.bs, drop_last<span class="op">=</span><span class="va">self</span>.drop_last)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-202" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-202" data-code-lines="3" data-code-annotation="1"><code>fastcore</code>’s <code>chunked</code> function has the exact same functionality as <code>islice</code>, but with some extra quality of life features. This includes being able to specify how many chunks, or slices, we want back (rather than the number of elements in a chunk), as well as being able to specify whether we would like to drop, or keep, chunks that are smaller than our specified chunk size. This latter option is what we will use–it will abstract away the <code>min</code> check we use in our <code>DataLoader</code> (<code>self.ds[i:min(len(self.ds), i+self.bs)]</code>).</span>
</dd>
</dl>
</div>
</div>

<div class="no-row-height column-margin column-container"><div id="cell-304" class="cell" data-execution_count="200">
<div class="sourceCode cell-code" id="cb305" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a>??chunked</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> chunked<span class="ansi-blue-fg">(</span>it<span class="ansi-blue-fg">,</span> chunk_sz<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> drop_last<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> n_chunks<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">Source:</span>   

<span class="ansi-green-fg">def</span> chunked<span class="ansi-blue-fg">(</span>it<span class="ansi-blue-fg">,</span> chunk_sz<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span> drop_last<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span> n_chunks<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

    <span class="ansi-blue-fg">"Return batches from iterator `it` of size `chunk_sz` (or return `n_chunks` total)"</span>

    <span class="ansi-green-fg">assert</span> bool<span class="ansi-blue-fg">(</span>chunk_sz<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">^</span> bool<span class="ansi-blue-fg">(</span>n_chunks<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">if</span> n_chunks<span class="ansi-blue-fg">:</span> chunk_sz <span class="ansi-blue-fg">=</span> max<span class="ansi-blue-fg">(</span>math<span class="ansi-blue-fg">.</span>ceil<span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>it<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">/</span>n_chunks<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> isinstance<span class="ansi-blue-fg">(</span>it<span class="ansi-blue-fg">,</span> Iterator<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> it <span class="ansi-blue-fg">=</span> iter<span class="ansi-blue-fg">(</span>it<span class="ansi-blue-fg">)</span>

    <span class="ansi-green-fg">while</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">:</span>

        res <span class="ansi-blue-fg">=</span> list<span class="ansi-blue-fg">(</span>itertools<span class="ansi-blue-fg">.</span>islice<span class="ansi-blue-fg">(</span>it<span class="ansi-blue-fg">,</span> chunk_sz<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>

        <span class="ansi-green-fg">if</span> res <span class="ansi-green-fg">and</span> <span class="ansi-blue-fg">(</span>len<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">==</span>chunk_sz <span class="ansi-green-fg">or</span> <span class="ansi-green-fg">not</span> drop_last<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">yield</span> res

        <span class="ansi-green-fg">if</span> len<span class="ansi-blue-fg">(</span>res<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">&lt;</span>chunk_sz<span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span>

<span class="ansi-red-fg">File:</span>      ~/mambaforge/envs/default/lib/python3.10/site-packages/fastcore/basics.py

<span class="ansi-red-fg">Type:</span>      function</pre>
</div>
</div>
</div></div><div id="cell-305" class="cell" data-execution_count="201">
<div class="sourceCode cell-code" id="cb306" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(islice(ss, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="201">
<pre data-code-line-numbers=""><code>[0, 1, 2, 3, 4]</code></pre>
</div>
</div>
<div id="cell-306" class="cell" data-execution_count="202">
<div class="sourceCode cell-code" id="cb308" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(chunked(ss, <span class="dv">5</span>))[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="202">
<pre data-code-line-numbers=""><code>[[0, 1, 2, 3, 4],
 [5, 6, 7, 8, 9],
 [10, 11, 12, 13, 14],
 [15, 16, 17, 18, 19],
 [20, 21, 22, 23, 24]]</code></pre>
</div>
</div>
<div id="cell-307" class="cell" data-execution_count="203">
<div class="sourceCode cell-code" id="cb310" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>batches <span class="op">=</span> BatchSampler(ss, <span class="dv">4</span>)</span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(islice(batches, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="203">
<pre data-code-line-numbers=""><code>[[0, 1, 2, 3],
 [4, 5, 6, 7],
 [8, 9, 10, 11],
 [12, 13, 14, 15],
 [16, 17, 18, 19]]</code></pre>
</div>
</div>
</section>
<section id="collation" class="level3">
<h3 class="anchored" data-anchor-id="collation">Collation</h3>
<p>There is one last piece of the puzzle left. Each sample in our <code>Dataset</code> also stores its associated target. We need to split these apart when dataloading. In other words, we need to split the data and target in each sample into their own batches; into an <code>x</code> batch and a <code>y</code> batch.</p>
<div id="cell-310" class="cell" data-execution_count="204">
<div class="sourceCode cell-code" id="cb312" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> collate(b):</span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>  xs, ys <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>b)</span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> torch.stack(xs), torch.stack(ys)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-311" class="cell" data-execution_count="205">
<div class="sourceCode cell-code" id="cb313" data-source-line-numbers="nil" data-code-line-numbers="3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataLoader():</span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ds, batches, collate_fn<span class="op">=</span>collate): store_attr()</span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__iter__</span>(<span class="va">self</span>): <span class="cf">yield</span> <span class="cf">from</span> (<span class="va">self</span>.collate_fn(<span class="va">self</span>.ds[i] <span class="cf">for</span> i <span class="kw">in</span> b) <span class="cf">for</span> b <span class="kw">in</span> <span class="va">self</span>.batches) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s breakdown the latter line and explore what it does, piece by piece.</p>
<div id="cell-313" class="cell" data-execution_count="206">
<div class="sourceCode cell-code" id="cb314" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>trn_samp <span class="op">=</span> BatchSampler(Sampler(trn_ds, shuffle<span class="op">=</span><span class="va">True</span>), bs)</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>vld_samp <span class="op">=</span> BatchSampler(Sampler(vld_ds, shuffle<span class="op">=</span><span class="va">False</span>), bs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>for b in self.batches</code>, we loop through each batch.</p>
<div id="cell-315" class="cell" data-execution_count="207">
<div class="sourceCode cell-code" id="cb315" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(vld_samp))<span class="op">;</span> b[:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="207">
<pre data-code-line-numbers=""><code>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</code></pre>
</div>
</div>
<p><code>self.ds[i] for i in b</code>; using the indices in each batch, we access the respective samples in the dataset.</p>
<div id="cell-317" class="cell" data-execution_count="208">
<div class="sourceCode cell-code" id="cb317" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a>p <span class="op">=</span> [vld_ds[i] <span class="cf">for</span> i <span class="kw">in</span> b]<span class="op">;</span> <span class="bu">len</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="208">
<pre data-code-line-numbers=""><code>50</code></pre>
</div>
</div>
<p>As can be seen below, <code>p</code> also stores the target.</p>
<div id="cell-319" class="cell" data-execution_count="209">
<div class="sourceCode cell-code" id="cb319" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a>p[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="209">
<pre data-code-line-numbers=""><code>(tensor([0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.18, 0.62, 0.76, 0.80, 0.28, 0.34, 0.05, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.05, 0.93, 0.99, 0.99, 0.99,
         0.99, 0.99, 0.89, 0.33, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.05, 0.77, 0.69, 0.50, 0.69, 0.81, 0.92, 0.96, 0.87, 0.09, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.08, 0.54, 0.99, 0.37, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.30, 0.99,
         0.56, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.07, 0.78, 0.99, 0.66, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.18, 0.85, 0.99, 0.84, 0.11, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.37, 0.88, 0.99, 0.96, 0.25, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.05, 0.50, 0.98, 0.99, 0.92,
         0.16, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.67, 0.99, 0.99, 0.66, 0.23, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.81, 0.99, 0.99, 0.25, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.54, 0.99, 0.99, 0.98, 0.57, 0.10, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.04, 0.68, 0.88,
         0.99, 0.99, 0.90, 0.28, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.03, 0.05, 0.99, 0.99, 0.99, 0.96, 0.41, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.18, 0.74, 0.99, 0.99, 0.88, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.04, 0.00, 0.00, 0.00, 0.00, 0.00, 0.07, 0.68, 0.99,
         0.99, 0.10, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.14, 0.90, 0.61, 0.44,
         0.34, 0.73, 0.75, 0.85, 0.99, 0.99, 0.86, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.47, 1.00, 0.99, 0.99, 0.99, 0.99, 1.00, 0.99, 0.99, 0.95, 0.26, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.54, 1.00, 0.99, 0.99, 0.99, 0.99, 1.00, 0.67, 0.18, 0.09, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.02, 0.28, 0.64, 0.74, 0.68, 0.68, 0.26, 0.02,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00,
         0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00]),
 tensor(3))</code></pre>
</div>
</div>
<p>Then we simply run the collate function.</p>
<div id="cell-321" class="cell" data-execution_count="210">
<div class="sourceCode cell-code" id="cb321" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a>xs, ys <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>p)<span class="op">;</span> ys</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="210">
<pre data-code-line-numbers=""><code>(tensor(3),
 tensor(8),
 tensor(6),
 tensor(9),
 tensor(6),
 tensor(4),
 tensor(5),
 tensor(3),
 tensor(8),
 tensor(4),
 tensor(5),
 tensor(2),
 tensor(3),
 tensor(8),
 tensor(4),
 tensor(8),
 tensor(1),
 tensor(5),
 tensor(0),
 tensor(5),
 tensor(9),
 tensor(7),
 tensor(4),
 tensor(1),
 tensor(0),
 tensor(3),
 tensor(0),
 tensor(6),
 tensor(2),
 tensor(9),
 tensor(9),
 tensor(4),
 tensor(1),
 tensor(3),
 tensor(6),
 tensor(8),
 tensor(0),
 tensor(7),
 tensor(7),
 tensor(6),
 tensor(8),
 tensor(9),
 tensor(0),
 tensor(3),
 tensor(8),
 tensor(3),
 tensor(7),
 tensor(7),
 tensor(8),
 tensor(4))</code></pre>
</div>
</div>
<p>And there we have our collated <code>x</code> and <code>y</code> batches!</p>
<div id="cell-323" class="cell" data-execution_count="211">
<div class="sourceCode cell-code" id="cb323" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a>torch.stack(ys)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="211">
<pre data-code-line-numbers=""><code>tensor([3, 8, 6, 9, 6, 4, 5, 3, 8, 4, 5, 2, 3, 8, 4, 8, 1, 5, 0, 5, 9, 7, 4, 1, 0, 3, 0, 6, 2, 9, 9, 4, 1, 3, 6, 8, 0, 7, 7, 6, 8, 9, 0, 3,
        8, 3, 7, 7, 8, 4])</code></pre>
</div>
</div>
<div id="cell-324" class="cell" data-execution_count="212">
<div class="sourceCode cell-code" id="cb325" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a>trn_samp <span class="op">=</span> BatchSampler(Sampler(trn_ds, shuffle<span class="op">=</span><span class="va">True</span>), bs)</span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>vld_samp <span class="op">=</span> BatchSampler(Sampler(vld_ds, shuffle<span class="op">=</span><span class="va">False</span>), bs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-325" class="cell" data-execution_count="213">
<div class="sourceCode cell-code" id="cb326" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a>trn_dl <span class="op">=</span> DataLoader(trn_ds, batches<span class="op">=</span>trn_samp)</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>vld_dl <span class="op">=</span> DataLoader(vld_ds, batches<span class="op">=</span>vld_samp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-326" class="cell" data-execution_count="214">
<div class="sourceCode cell-code" id="cb327" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(vld_dl))</span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a>plt.imshow(xb[<span class="dv">0</span>].view(<span class="dv">28</span>, <span class="dv">28</span>))</span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a>yb[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="214">
<pre data-code-line-numbers=""><code>tensor(3)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="20_models_from_scratch_files/figure-html/cell-215-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-327" class="cell" data-execution_count="215">
<div class="sourceCode cell-code" id="cb329" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="215">
<pre data-code-line-numbers=""><code>(torch.Size([50, 784]), torch.Size([50]))</code></pre>
</div>
</div>
<div id="cell-328" class="cell" data-execution_count="216">
<div class="sourceCode cell-code" id="cb331" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a>model, opt <span class="op">=</span> get_model()</span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 1.03; Accuracy: 0.74
Loss: 0.46; Accuracy: 0.82
Loss: 0.30; Accuracy: 0.90</code></pre>
</div>
</div>
<p>We do not need to update the <code>fit()</code> function, as its logic remains the same despite our changes to the dataloader.</p>
<div id="cell-330" class="cell" data-execution_count="217">
<div class="sourceCode cell-code" id="cb333" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a>??fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> fit<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">Docstring:</span> &lt;no docstring&gt;

<span class="ansi-red-fg">Source:</span>   

<span class="ansi-green-fg">def</span> fit<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

  <span class="ansi-green-fg">for</span> epoch <span class="ansi-green-fg">in</span> range<span class="ansi-blue-fg">(</span>epochs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

    <span class="ansi-green-fg">for</span> xb<span class="ansi-blue-fg">,</span> yb <span class="ansi-green-fg">in</span> trn_dl<span class="ansi-blue-fg">:</span> <span class="ansi-red-fg"># &lt;&lt;</span>

      preds <span class="ansi-blue-fg">=</span> model<span class="ansi-blue-fg">(</span>xb<span class="ansi-blue-fg">)</span>

      loss <span class="ansi-blue-fg">=</span> loss_func<span class="ansi-blue-fg">(</span>preds<span class="ansi-blue-fg">,</span> yb<span class="ansi-blue-fg">)</span>

      loss<span class="ansi-blue-fg">.</span>backward<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

      opt<span class="ansi-blue-fg">.</span>step<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

      opt<span class="ansi-blue-fg">.</span>zero_grad<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>

    report<span class="ansi-blue-fg">(</span>loss<span class="ansi-blue-fg">,</span> preds<span class="ansi-blue-fg">,</span> yb<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">File:</span>      /var/folders/fy/vg316qk1001227svr6d4d8l40000gn/T/ipykernel_52843/769712355.py

<span class="ansi-red-fg">Type:</span>      function</pre>
</div>
</div>
</div>
</section>
<section id="multiprocessing-dataloader" class="level3">
<h3 class="anchored" data-anchor-id="multiprocessing-dataloader">Multiprocessing DataLoader</h3>
<p>We can speed up how quickly data is loaded by using multiple CPU cores.</p>
<div id="cell-333" class="cell" data-execution_count="218">
<div class="sourceCode cell-code" id="cb334" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>timeit</span>
<span id="cb334-2"><a href="#cb334-2" aria-hidden="true" tabindex="-1"></a>it <span class="op">=</span> <span class="bu">iter</span>(trn_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>227 ns ± 1.45 ns per loop (mean ± std. dev. of 7 runs, 1,000,000 loops each)</code></pre>
</div>
</div>
<div id="cell-334" class="cell" data-execution_count="219">
<div class="sourceCode cell-code" id="cb336" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.multiprocessing <span class="im">as</span> mp</span>
<span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataLoader():</span>
<span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, ds, batches, n_workers<span class="op">=</span><span class="dv">1</span>, collate_fun<span class="op">=</span>collate): store_attr()</span>
<span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__iter__</span>(<span class="va">self</span>):</span>
<span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mp.Pool(<span class="va">self</span>.n_workers) <span class="im">as</span> ex: <span class="cf">yield</span> <span class="cf">from</span> ex.<span class="bu">map</span>(<span class="va">self</span>.ds.<span class="fu">__getitem__</span>, <span class="bu">iter</span>(<span class="va">self</span>.batches))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-335" class="cell" data-execution_count="220">
<div class="sourceCode cell-code" id="cb337" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>trn_dl <span class="op">=</span> DataLoader(trn_ds, batches<span class="op">=</span>trn_samp, n_workers<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-336" class="cell" data-execution_count="221">
<div class="sourceCode cell-code" id="cb338" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>timeit</span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>it <span class="op">=</span> <span class="bu">iter</span>(trn_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>197 ns ± 0.557 ns per loop (mean ± std. dev. of 7 runs, 1,000,000 loops each)</code></pre>
</div>
</div>
<p>Let’s break down how exactly our <code>__iter__</code> method works.</p>
<p>We slice batches by specifying a list of indices.</p>
<div id="cell-339" class="cell" data-execution_count="222">
<div class="sourceCode cell-code" id="cb340" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a>trn_ds[[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="222">
<pre data-code-line-numbers=""><code>(tensor([[0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.]]),
 tensor([1, 1, 1, 0]))</code></pre>
</div>
</div>
<p>Behind the scenes, the square bracket notation calls the <code>__getitem__</code> dunder method.</p>
<div id="cell-341" class="cell" data-execution_count="223">
<div class="sourceCode cell-code" id="cb342" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb342-1"><a href="#cb342-1" aria-hidden="true" tabindex="-1"></a>??trn_ds.<span class="fu">__getitem__</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> trn_ds<span class="ansi-blue-fg">.</span>__getitem__<span class="ansi-blue-fg">(</span>i<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">Docstring:</span> &lt;no docstring&gt;

<span class="ansi-red-fg">Source:</span>      <span class="ansi-green-fg">def</span> __getitem__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> i<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span> <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>x<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>y<span class="ansi-blue-fg">[</span>i<span class="ansi-blue-fg">]</span>

<span class="ansi-red-fg">File:</span>      /var/folders/fy/vg316qk1001227svr6d4d8l40000gn/T/ipykernel_52843/694427655.py

<span class="ansi-red-fg">Type:</span>      method</pre>
</div>
</div>
</div>
<p>In fact, we can index directly using <code>__getitem__</code>.</p>
<div id="cell-343" class="cell" data-execution_count="224">
<div class="sourceCode cell-code" id="cb343" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a>trn_ds.<span class="fu">__getitem__</span>([<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="224">
<pre data-code-line-numbers=""><code>(tensor([[0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.]]),
 tensor([1, 1, 1, 0]))</code></pre>
</div>
</div>
<p>Therefore, by dividing our batches into smaller sets, we can take advantage of the <code>__getitem__</code> dunder method to allow each CPU core to handle a separate set of items.</p>
<p>So we can divide our batches into smaller sets that each CPU core can manage.</p>
<div id="cell-345" class="cell" data-execution_count="225">
<div class="sourceCode cell-code" id="cb345" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(<span class="bu">list</span>(<span class="bu">map</span>(trn_ds.<span class="fu">__getitem__</span>, ([<span class="dv">3</span>, <span class="dv">6</span>], [<span class="dv">8</span>, <span class="dv">1</span>]))))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="225">
<pre data-code-line-numbers=""><code>2</code></pre>
</div>
</div>
<div id="cell-346" class="cell" data-execution_count="226">
<div class="sourceCode cell-code" id="cb347" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> o <span class="kw">in</span> <span class="bu">map</span>(trn_ds.<span class="fu">__getitem__</span>, ([<span class="dv">3</span>, <span class="dv">6</span>], [<span class="dv">8</span>, <span class="dv">1</span>])): <span class="bu">print</span>(o)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>(tensor([[0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.]]), tensor([1, 1]))
(tensor([[0., 0., 0.,  ..., 0., 0., 0.],
        [0., 0., 0.,  ..., 0., 0., 0.]]), tensor([1, 0]))</code></pre>
</div>
</div>
</section>
<section id="sampling-in-pytorch" class="level3">
<h3 class="anchored" data-anchor-id="sampling-in-pytorch">Sampling in PyTorch</h3>
<div id="cell-348" class="cell" data-execution_count="227">
<div class="sourceCode cell-code" id="cb349" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader, SequentialSampler, RandomSampler, BatchSampler</span>
<span id="cb349-2"><a href="#cb349-2" aria-hidden="true" tabindex="-1"></a>?BatchSampler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>

BatchSampler<span class="ansi-blue-fg">(</span>

    sampler<span class="ansi-blue-fg">:</span> Union<span class="ansi-blue-fg">[</span>torch<span class="ansi-blue-fg">.</span>utils<span class="ansi-blue-fg">.</span>data<span class="ansi-blue-fg">.</span>sampler<span class="ansi-blue-fg">.</span>Sampler<span class="ansi-blue-fg">[</span>int<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> Iterable<span class="ansi-blue-fg">[</span>int<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>

    batch_size<span class="ansi-blue-fg">:</span> int<span class="ansi-blue-fg">,</span>

    drop_last<span class="ansi-blue-fg">:</span> bool<span class="ansi-blue-fg">,</span>

<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> <span class="ansi-green-fg">None</span>

<span class="ansi-red-fg">Docstring:</span>     

Wraps another sampler to yield a mini-batch of indices.



Args:

    sampler (Sampler or Iterable): Base sampler. Can be any iterable object

    batch_size (int): Size of mini-batch.

    drop_last (bool): If ``True``, the sampler will drop the last batch if

        its size would be less than ``batch_size``



Example:

    &gt;&gt;&gt; list(BatchSampler(SequentialSampler(range(10)), batch_size=3, drop_last=False))

    [[0, 1, 2], [3, 4, 5], [6, 7, 8], [9]]

    &gt;&gt;&gt; list(BatchSampler(SequentialSampler(range(10)), batch_size=3, drop_last=True))

    [[0, 1, 2], [3, 4, 5], [6, 7, 8]]

<span class="ansi-red-fg">File:</span>           ~/mambaforge/envs/default/lib/python3.10/site-packages/torch/utils/data/sampler.py

<span class="ansi-red-fg">Type:</span>           type

<span class="ansi-red-fg">Subclasses:</span>     </pre>
</div>
</div>
</div>
<p>PyTorch provides a wrapper which assembles the indices, sampled by our desired sampler, into batches.</p>
<div id="cell-350" class="cell" data-execution_count="228">
<div class="sourceCode cell-code" id="cb350" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a>?RandomSampler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>

RandomSampler<span class="ansi-blue-fg">(</span>

    data_source<span class="ansi-blue-fg">:</span> Sized<span class="ansi-blue-fg">,</span>

    replacement<span class="ansi-blue-fg">:</span> bool <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>

    num_samples<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>int<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    generator<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> <span class="ansi-green-fg">None</span>

<span class="ansi-red-fg">Docstring:</span>     

Samples elements randomly. If without replacement, then sample from a shuffled dataset.

If with replacement, then user can specify :attr:`num_samples` to draw.



Args:

    data_source (Dataset): dataset to sample from

    replacement (bool): samples are drawn on-demand with replacement if ``True``, default=``False``

    num_samples (int): number of samples to draw, default=`len(dataset)`.

    generator (Generator): Generator used in sampling.

<span class="ansi-red-fg">File:</span>           ~/mambaforge/envs/default/lib/python3.10/site-packages/torch/utils/data/sampler.py

<span class="ansi-red-fg">Type:</span>           type

<span class="ansi-red-fg">Subclasses:</span>     </pre>
</div>
</div>
</div>
<div id="cell-351" class="cell" data-execution_count="229">
<div class="sourceCode cell-code" id="cb351" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a>trn_samp <span class="op">=</span> BatchSampler(    RandomSampler(trn_ds), bs, drop_last<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb351-2"><a href="#cb351-2" aria-hidden="true" tabindex="-1"></a>vld_samp <span class="op">=</span> BatchSampler(SequentialSampler(vld_ds), bs, drop_last<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To construct a dataloader with PyTorch, we have to provide the dataset and a sampler.</p>
<div id="cell-353" class="cell" data-execution_count="230">
<div class="sourceCode cell-code" id="cb352" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>?DataLoader</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Init signature:</span>

DataLoader<span class="ansi-blue-fg">(</span>

    dataset<span class="ansi-blue-fg">:</span> torch<span class="ansi-blue-fg">.</span>utils<span class="ansi-blue-fg">.</span>data<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">.</span>Dataset<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">+</span>T_co<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span>

    batch_size<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>int<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">,</span>

    shuffle<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>bool<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    sampler<span class="ansi-blue-fg">:</span> Union<span class="ansi-blue-fg">[</span>torch<span class="ansi-blue-fg">.</span>utils<span class="ansi-blue-fg">.</span>data<span class="ansi-blue-fg">.</span>sampler<span class="ansi-blue-fg">.</span>Sampler<span class="ansi-blue-fg">,</span> Iterable<span class="ansi-blue-fg">,</span> NoneType<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    batch_sampler<span class="ansi-blue-fg">:</span> Union<span class="ansi-blue-fg">[</span>torch<span class="ansi-blue-fg">.</span>utils<span class="ansi-blue-fg">.</span>data<span class="ansi-blue-fg">.</span>sampler<span class="ansi-blue-fg">.</span>Sampler<span class="ansi-blue-fg">[</span>Sequence<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> Iterable<span class="ansi-blue-fg">[</span>Sequence<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> NoneType<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    num_workers<span class="ansi-blue-fg">:</span> int <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span>

    collate_fn<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>Callable<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">[</span>List<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">~</span>T<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> Any<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    pin_memory<span class="ansi-blue-fg">:</span> bool <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>

    drop_last<span class="ansi-blue-fg">:</span> bool <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>

    timeout<span class="ansi-blue-fg">:</span> float <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">,</span>

    worker_init_fn<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>Callable<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">[</span>int<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">,</span> NoneType<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    multiprocessing_context<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    generator<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    <span class="ansi-blue-fg">*</span><span class="ansi-blue-fg">,</span>

    prefetch_factor<span class="ansi-blue-fg">:</span> Optional<span class="ansi-blue-fg">[</span>int<span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span><span class="ansi-blue-fg">,</span>

    persistent_workers<span class="ansi-blue-fg">:</span> bool <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">False</span><span class="ansi-blue-fg">,</span>

    pin_memory_device<span class="ansi-blue-fg">:</span> str <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">''</span><span class="ansi-blue-fg">,</span>

<span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">Docstring:</span>     

Data loader. Combines a dataset and a sampler, and provides an iterable over

the given dataset.



The :class:`~torch.utils.data.DataLoader` supports both map-style and

iterable-style datasets with single- or multi-process loading, customizing

loading order and optional automatic batching (collation) and memory pinning.



See :py:mod:`torch.utils.data` documentation page for more details.



Args:

    dataset (Dataset): dataset from which to load the data.

    batch_size (int, optional): how many samples per batch to load

        (default: ``1``).

    shuffle (bool, optional): set to ``True`` to have the data reshuffled

        at every epoch (default: ``False``).

    sampler (Sampler or Iterable, optional): defines the strategy to draw

        samples from the dataset. Can be any ``Iterable`` with ``__len__``

        implemented. If specified, :attr:`shuffle` must not be specified.

    batch_sampler (Sampler or Iterable, optional): like :attr:`sampler`, but

        returns a batch of indices at a time. Mutually exclusive with

        :attr:`batch_size`, :attr:`shuffle`, :attr:`sampler`,

        and :attr:`drop_last`.

    num_workers (int, optional): how many subprocesses to use for data

        loading. ``0`` means that the data will be loaded in the main process.

        (default: ``0``)

    collate_fn (Callable, optional): merges a list of samples to form a

        mini-batch of Tensor(s).  Used when using batched loading from a

        map-style dataset.

    pin_memory (bool, optional): If ``True``, the data loader will copy Tensors

        into device/CUDA pinned memory before returning them.  If your data elements

        are a custom type, or your :attr:`collate_fn` returns a batch that is a custom type,

        see the example below.

    drop_last (bool, optional): set to ``True`` to drop the last incomplete batch,

        if the dataset size is not divisible by the batch size. If ``False`` and

        the size of dataset is not divisible by the batch size, then the last batch

        will be smaller. (default: ``False``)

    timeout (numeric, optional): if positive, the timeout value for collecting a batch

        from workers. Should always be non-negative. (default: ``0``)

    worker_init_fn (Callable, optional): If not ``None``, this will be called on each

        worker subprocess with the worker id (an int in ``[0, num_workers - 1]``) as

        input, after seeding and before data loading. (default: ``None``)

    generator (torch.Generator, optional): If not ``None``, this RNG will be used

        by RandomSampler to generate random indexes and multiprocessing to generate

        `base_seed` for workers. (default: ``None``)

    prefetch_factor (int, optional, keyword-only arg): Number of batches loaded

        in advance by each worker. ``2`` means there will be a total of

        2 * num_workers batches prefetched across all workers. (default value depends

        on the set value for num_workers. If value of num_workers=0 default is ``None``.

        Otherwise if value of num_workers&gt;0 default is ``2``).

    persistent_workers (bool, optional): If ``True``, the data loader will not shutdown

        the worker processes after a dataset has been consumed once. This allows to

        maintain the workers `Dataset` instances alive. (default: ``False``)

    pin_memory_device (str, optional): the data loader will copy Tensors

        into device pinned memory before returning them if pin_memory is set to true.





.. warning:: If the ``spawn`` start method is used, :attr:`worker_init_fn`

             cannot be an unpicklable object, e.g., a lambda function. See

             :ref:`multiprocessing-best-practices` on more details related

             to multiprocessing in PyTorch.



.. warning:: ``len(dataloader)`` heuristic is based on the length of the sampler used.

             When :attr:`dataset` is an :class:`~torch.utils.data.IterableDataset`,

             it instead returns an estimate based on ``len(dataset) / batch_size``, with proper

             rounding depending on :attr:`drop_last`, regardless of multi-process loading

             configurations. This represents the best guess PyTorch can make because PyTorch

             trusts user :attr:`dataset` code in correctly handling multi-process

             loading to avoid duplicate data.



             However, if sharding results in multiple workers having incomplete last batches,

             this estimate can still be inaccurate, because (1) an otherwise complete batch can

             be broken into multiple ones and (2) more than one batch worth of samples can be

             dropped when :attr:`drop_last` is set. Unfortunately, PyTorch can not detect such

             cases in general.



             See `Dataset Types`_ for more details on these two types of datasets and how

             :class:`~torch.utils.data.IterableDataset` interacts with

             `Multi-process data loading`_.



.. warning:: See :ref:`reproducibility`, and :ref:`dataloader-workers-random-seed`, and

             :ref:`data-loading-randomness` notes for random seed related questions.

<span class="ansi-red-fg">File:</span>           ~/mambaforge/envs/default/lib/python3.10/site-packages/torch/utils/data/dataloader.py

<span class="ansi-red-fg">Type:</span>           type

<span class="ansi-red-fg">Subclasses:</span>     </pre>
</div>
</div>
</div>
<div id="cell-354" class="cell" data-execution_count="231">
<div class="sourceCode cell-code" id="cb353" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>trn_dl <span class="op">=</span> DataLoader(trn_ds, batch_sampler<span class="op">=</span>trn_samp, collate_fn<span class="op">=</span>collate)</span>
<span id="cb353-2"><a href="#cb353-2" aria-hidden="true" tabindex="-1"></a>vld_dl <span class="op">=</span> DataLoader(vld_dl, batch_sampler<span class="op">=</span>vld_samp, collate_fn<span class="op">=</span>collate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-355" class="cell" data-execution_count="232">
<div class="sourceCode cell-code" id="cb354" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>model, opt <span class="op">=</span> get_model()</span>
<span id="cb354-2"><a href="#cb354-2" aria-hidden="true" tabindex="-1"></a>fit()</span>
<span id="cb354-3"><a href="#cb354-3" aria-hidden="true" tabindex="-1"></a>loss_func(model(xb), yb), accuracy(model(xb), yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 1.05; Accuracy: 0.64
Loss: 0.69; Accuracy: 0.72
Loss: 0.55; Accuracy: 0.84</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="232">
<pre data-code-line-numbers=""><code>(tensor(1.02, grad_fn=&lt;NllLossBackward0&gt;), tensor(0.66))</code></pre>
</div>
</div>
<p>Instead of separately wrapping the <code>RandomSampler</code> and <code>SequentialSampler</code> classes, we can let the <code>DataLoader</code> class do this for us.</p>
<div id="cell-357" class="cell" data-execution_count="233">
<div class="sourceCode cell-code" id="cb357" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>trn_dl <span class="op">=</span> DataLoader(trn_ds, bs, sampler<span class="op">=</span>    RandomSampler(trn_ds), collate_fn<span class="op">=</span>collate)</span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a>vld_dl <span class="op">=</span> DataLoader(vld_ds, bs, sampler<span class="op">=</span>SequentialSampler(trn_ds), collate_fn<span class="op">=</span>collate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In fact, we don’t even need to specify the sampler. All we have to do is toggle and set some parameters.</p>
<div id="cell-359" class="cell" data-execution_count="234">
<div class="sourceCode cell-code" id="cb358" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>trn_dl <span class="op">=</span> DataLoader(trn_ds, bs, shuffle<span class="op">=</span><span class="va">True</span>, drop_last<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a>vld_dl <span class="op">=</span> DataLoader(vld_ds, bs, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-360" class="cell" data-execution_count="235">
<div class="sourceCode cell-code" id="cb359" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a>model, opt <span class="op">=</span> get_model()<span class="op">;</span> fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>Loss: 0.80; Accuracy: 0.80
Loss: 0.27; Accuracy: 0.94
Loss: 0.40; Accuracy: 0.88</code></pre>
</div>
</div>
<div id="cell-361" class="cell" data-execution_count="236">
<div class="sourceCode cell-code" id="cb361" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a>loss_func(model(xb), yb), accuracy(model(xb), yb)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="236">
<pre data-code-line-numbers=""><code>(tensor(0.84, grad_fn=&lt;NllLossBackward0&gt;), tensor(0.68))</code></pre>
</div>
</div>
<p>As our dataset already knows how to sample a batch of indices all at once, we can actually skip the <code>batch_sampler</code> and <code>collate_fn</code> entirely. 🙃</p>
<div class="sourceCode" id="cb363" data-code-line-numbers=""><pre class="sourceCode py code-with-copy"><code class="sourceCode python"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Dataset():</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, x, y): <span class="va">self</span>.x, <span class="va">self</span>.y <span class="op">=</span> x, y</span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>): <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.x)</span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, i): <span class="cf">return</span> <span class="va">self</span>.x[i], <span class="va">self</span>.y[i]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="cell-363" class="cell" data-execution_count="237">
<div class="sourceCode cell-code" id="cb364" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a>trn_ds[[<span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="237">
<pre data-code-line-numbers=""><code>(tensor([[0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.],
         [0., 0., 0.,  ..., 0., 0., 0.]]),
 tensor([9, 1, 3]))</code></pre>
</div>
</div>
<div id="cell-364" class="cell" data-execution_count="238">
<div class="sourceCode cell-code" id="cb366" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a>trn_dl <span class="op">=</span> DataLoader(trn_ds, sampler<span class="op">=</span>trn_samp)</span>
<span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a>vld_dl <span class="op">=</span> DataLoader(vld_ds, sampler<span class="op">=</span>vld_samp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-365" class="cell" data-execution_count="239">
<div class="sourceCode cell-code" id="cb367" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>xb, yb <span class="op">=</span> <span class="bu">next</span>(<span class="bu">iter</span>(trn_dl))<span class="op">;</span> xb.shape, yb.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="239">
<pre data-code-line-numbers=""><code>(torch.Size([1, 50, 784]), torch.Size([1, 50]))</code></pre>
</div>
</div>
</section>
</section>
<section id="validation" class="level2">
<h2 class="anchored" data-anchor-id="validation">Validation</h2>
<p>When training and evaluating a model, <code>model.train()</code> and <code>model.eval()</code> need to be called respectively. These methods are used by layers such as <code>nn.BatchNorm2d</code> and <code>nn.Dropout</code> to ensure appropriate behaviour during different phases of the process.</p>
<div id="cell-368" class="cell" data-execution_count="240">
<div class="sourceCode cell-code" id="cb369" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a>?model.train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> model<span class="ansi-blue-fg">.</span>train<span class="ansi-blue-fg">(</span>mode<span class="ansi-blue-fg">:</span> bool <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> <span class="ansi-blue-fg">~</span>T

<span class="ansi-red-fg">Docstring:</span>

Sets the module in training mode.



This has any effect only on certain modules. See documentations of

particular modules for details of their behaviors in training/evaluation

mode, if they are affected, e.g. :class:`Dropout`, :class:`BatchNorm`,

etc.



Args:

    mode (bool): whether to set training mode (``True``) or evaluation

                 mode (``False``). Default: ``True``.



Returns:

    Module: self

<span class="ansi-red-fg">File:</span>      ~/mambaforge/envs/default/lib/python3.10/site-packages/torch/nn/modules/module.py

<span class="ansi-red-fg">Type:</span>      method</pre>
</div>
</div>
</div>
<div id="cell-369" class="cell" data-execution_count="241">
<div class="sourceCode cell-code" id="cb370" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a>?model.<span class="bu">eval</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">Signature:</span> model<span class="ansi-blue-fg">.</span>eval<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> <span class="ansi-blue-fg">~</span>T

<span class="ansi-red-fg">Docstring:</span>

Sets the module in evaluation mode.



This has any effect only on certain modules. See documentations of

particular modules for details of their behaviors in training/evaluation

mode, if they are affected, e.g. :class:`Dropout`, :class:`BatchNorm`,

etc.



This is equivalent with :meth:`self.train(False) &lt;torch.nn.Module.train&gt;`.



See :ref:`locally-disable-grad-doc` for a comparison between

`.eval()` and several similar mechanisms that may be confused with it.



Returns:

    Module: self

<span class="ansi-red-fg">File:</span>      ~/mambaforge/envs/default/lib/python3.10/site-packages/torch/nn/modules/module.py

<span class="ansi-red-fg">Type:</span>      method</pre>
</div>
</div>
</div>
<div id="cell-370" class="cell" data-execution_count="242">
<div class="sourceCode cell-code" id="cb371" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit(epochs, model, loss_func, opt, train_dl, valid_dl):</span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(epochs):</span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> xb, yb <span class="kw">in</span> train_dl:</span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a>      preds <span class="op">=</span> model(xb)</span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a>      loss <span class="op">=</span> loss_func(preds, yb)</span>
<span id="cb371-7"><a href="#cb371-7" aria-hidden="true" tabindex="-1"></a>      loss.backward()</span>
<span id="cb371-8"><a href="#cb371-8" aria-hidden="true" tabindex="-1"></a>      opt.step()</span>
<span id="cb371-9"><a href="#cb371-9" aria-hidden="true" tabindex="-1"></a>      opt.zero_grad()</span>
<span id="cb371-10"><a href="#cb371-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb371-11"><a href="#cb371-11" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb371-12"><a href="#cb371-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb371-13"><a href="#cb371-13" aria-hidden="true" tabindex="-1"></a>      tot_loss, tot_acc, count <span class="op">=</span> (<span class="fl">0.</span>,) <span class="op">*</span> <span class="dv">3</span></span>
<span id="cb371-14"><a href="#cb371-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> xb, yb <span class="kw">in</span> valid_dl:</span>
<span id="cb371-15"><a href="#cb371-15" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> model(xb)</span>
<span id="cb371-16"><a href="#cb371-16" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(xb)</span>
<span id="cb371-17"><a href="#cb371-17" aria-hidden="true" tabindex="-1"></a>        count <span class="op">+=</span> n</span>
<span id="cb371-18"><a href="#cb371-18" aria-hidden="true" tabindex="-1"></a>        tot_loss <span class="op">+=</span> loss_func(preds, yb).item() <span class="op">*</span> n</span>
<span id="cb371-19"><a href="#cb371-19" aria-hidden="true" tabindex="-1"></a>        tot_acc  <span class="op">+=</span> accuracy (preds, yb).item() <span class="op">*</span> n</span>
<span id="cb371-20"><a href="#cb371-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(epoch, tot_loss<span class="op">/</span>count, tot_acc<span class="op">/</span>count)</span>
<span id="cb371-21"><a href="#cb371-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> tot_loss<span class="op">/</span>count, tot_acc<span class="op">/</span>count</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-371" class="cell" data-execution_count="243">
<div class="sourceCode cell-code" id="cb372" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_dls(trainn_ds, valid_ds, bs, <span class="op">**</span>kwargs):</span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (DataLoader(trn_ds, batch_size<span class="op">=</span>bs,   shuffle<span class="op">=</span><span class="va">True</span>, <span class="op">**</span>kwargs),</span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a>          DataLoader(vld_ds, batch_size<span class="op">=</span>bs<span class="op">*</span><span class="dv">2</span>,               <span class="op">**</span>kwargs))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-372" class="cell" data-execution_count="244">
<div class="sourceCode cell-code" id="cb373" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a>trn_dl, vld_dl <span class="op">=</span> get_dls(trn_ds, vld_ds, bs)</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>model, opt <span class="op">=</span> get_model()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-373" class="cell" data-execution_count="245">
<div class="sourceCode cell-code" id="cb374" data-source-line-numbers="nil" data-code-line-numbers="nil"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>time loss, acc <span class="op">=</span> fit(<span class="dv">5</span>, model, loss_func, opt, trn_dl, vld_dl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre data-code-line-numbers=""><code>0 1.3015430688858032 0.6180000007152557
1 0.7089294970035553 0.7680000007152558
2 0.6260120451450348 0.7990000009536743
3 0.501511612534523 0.8490000128746032
4 0.5909725487232208 0.8119999945163727
CPU times: user 1.55 s, sys: 41.8 ms, total: 1.59 s
Wall time: 358 ms</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>If you have any comments, questions, suggestions, feedback, criticisms, or corrections, please do post them down in the comment section below!</p>


</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/forbo7\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<input type="hidden" id="giscus-base-theme" value="light">
<input type="hidden" id="giscus-alt-theme" value="light">
<script>
  function loadGiscus() {
    // Function to get the theme based on body class
    const getTheme = () => {
      let baseTheme = document.getElementById('giscus-base-theme').value;
      let altTheme = document.getElementById('giscus-alt-theme').value;
      if (authorPrefersDark) {
          [baseTheme, altTheme] = [altTheme, baseTheme];
      }
      return document.body.classList.contains('quarto-dark') ? altTheme : baseTheme;
    };
    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.async = true;
    script.dataset.repo = "ForBo7/forbo7.github.io";
    script.dataset.repoId = "R_kgDOICXnAA";
    script.dataset.category = "Giscus Comments";
    script.dataset.categoryId = "DIC_kwDOICXnAM4CR8YX";
    script.dataset.mapping = "title";
    script.dataset.reactionsEnabled = "1";
    script.dataset.emitMetadata = "0";
    script.dataset.inputPosition = "top";
    script.dataset.theme = getTheme();
    script.dataset.lang = "en";
    script.crossOrigin = "anonymous";
    // Append the script to the desired div instead of at the end of the body
    document.getElementById("quarto-content").appendChild(script);
  }
  loadGiscus();
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><a href="https://forbo7.github.io/">ForBo7 // Salman Naqvi</a> © 2022–2025 to ∞ and ForBlog™ by <a href="https://forbo7.github.io/about.html">Salman Naqvi</a></p>
</div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://forums.fast.ai/u/forbo7/summary">
      <i class="bi bi-file-post-fill" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/ForBo7_">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://www.artstation.com/forbo7">
      <i class="bi bi-brush" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="mailto:salmananaqvii+forblog@gmail.com">
      <i class="bi bi-envelope" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../forblog/index.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
<p><a href="https://forbo7.github.io/patch_notes.html">Version 2.2.2.0</a> | <a href="https://forbo7.github.io/feedback.html">Feedback</a> | Website made with <a href="https://quarto.org/">Quarto</a>, by me!</p>
</div>
  </div>
</footer>




<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
<script src="../../site_libs/quarto-contrib/line-highlight-1.0.0/line-highlight.js" defer="true"></script>
</body></html>